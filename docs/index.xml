<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Safouane Chergui</title>
<link>https://chsafouane.github.io/</link>
<atom:link href="https://chsafouane.github.io/index.xml" rel="self" type="application/rss+xml"/>
<description>Just a fancy note-taking website for my notes not to die on my iPad</description>
<generator>quarto-1.7.33</generator>
<lastBuildDate>Thu, 05 Feb 2026 23:00:00 GMT</lastBuildDate>
<item>
  <title>Why filtering breaks your vector search</title>
  <dc:creator>Safouane Chergui</dc:creator>
  <link>https://chsafouane.github.io/posts/Why WHERE clauses can break your vector search/Why filtering can break your vector search.html</link>
  <description><![CDATA[ 





<p>Semantic search works until you add a filter. You search for ‚Äúwireless earbuds‚Äù, get great results, but then you decide to add a filter on brands <code>WHERE brand IN ('Apple', 'Google')</code> and suddenly many results vanish or you get nothing back at all, even if the data has results for your query.</p>
<p>This isn‚Äôt a bug in your system but there is a reason why filtering breaks your vector search, and it all has to do with how HNSW works.</p>
<p>This post explains the problem, quantifies how bad it gets, and walks through one of the elegant solutions there exists in vector DBs today which how Qdrant solves it.</p>
<section id="a-quick-recap-on-hnsw" class="level1">
<h1>1. A quick recap on HNSW</h1>
<p>Suppose you‚Äôre querying a vector DB with a query embedding <code>q</code>. An easy way to find the nearest neighbors is <strong>exhaustive search</strong>: compute the similarity between <code>q</code> and all the stored vectors, then take the top k results. That gives exact results but it scales linearly. With N items in your vector DB, you perform <code>O(N)</code> distance evaluations per query. This works great for small datasets but the latency grows rapidly once you start dealing with bigger datasets.</p>
<p>A more realistic way to think about it: imagine you live in a world with no internet and you‚Äôre trying to find the best restaurant in an entire country. You wouldn‚Äôt inspect every street and every menu. Instead, you‚Äôd use a <em>navigation strategy</em>, maybe:</p>
<ul>
<li>You‚Äôll start by choosing a city that is known for its good restaurants</li>
<li>Then you‚Äôll ask locals and head to likely part of town</li>
<li>Once in there, you‚Äôll ask locals again to go to the right neighborhood</li>
<li>Finally, you‚Äôll only compare restaurants in that neighborhood</li>
</ul>
<p>At the end of the day, you are trading a tiny risk of missing the absolute best restaurant in the country for a massive speedup.</p>
<p><strong>Approximate Nearest Neighbor (ANN)</strong> algorithms formalize this trade-off for vector search. In practice, many vector databases use <strong>HNSW</strong> (Hierarchical Navigable Small World) as their default ANN index. HNSW builds a graph that lets the query ‚Äúwalk‚Äù toward closer and closer candidates without scanning everything.</p>
<p>Btw, if you need a good course about vector search, HNSW and all things related to this, take a look at the free <a href="https://qdrant.tech/course/essentials/">Qdrant Essentials</a> course (not sponsored).</p>
<section id="how-does-it-work" class="level2">
<h2 class="anchored" data-anchor-id="how-does-it-work">How does it work?</h2>
<p>Think back to the ‚Äúno internet‚Äù restaurant problem from the previous section. You want the best restaurant in an entire country. Doing it exactly would mean visiting every street and reading every menu. HNSW turns your ‚Äúask the locals‚Äù strategy into reality.</p>
<section id="the-intuition" class="level3">
<h3 class="anchored" data-anchor-id="the-intuition">The intuition</h3>
<p>Your dataset is the country. Each item (vector) is a restaurant somewhere on the map. Your query vector is your personal taste.</p>
<p>HNSW pre-builds ‚Äúlocal recommendations‚Äù: each restaurant knows a handful of nearby restaurants (nearby in embedding space). At query time, you hop from one promising candidate to the next until you‚Äôre in the right neighborhood, then you refine the shortlist.</p>
</section>
<section id="under-the-hood" class="level3">
<h3 class="anchored" data-anchor-id="under-the-hood">Under the hood</h3>
<p>HNSW stores a graph:</p>
<ul>
<li>each vector is a node</li>
<li>each node connects to a small set of nearby nodes (neighbors), where <em>nearby</em> is defined by your similarity metric (often cosine)</li>
</ul>
<p>At query time, the search looks like this:</p>
<ol type="1">
<li>Start from the index‚Äôs entry point (a specific node stored in the HNSW structure).</li>
<li>Keep a <em>shortlist</em> of the best candidates you‚Äôve seen so far.</li>
<li>Repeatedly expand the most promising candidate by checking its neighbors and updating the shortlist.</li>
<li>Stop when your budget is exhausted and return the top <img src="https://latex.codecogs.com/png.latex?K"> from the shortlist.</li>
</ol>
<p>The key knob at query time is <code>ef</code> (Qdrant: <code>hnsw_ef</code>) which determines <strong>how wide that shortlist is allowed to be.</strong> Bigger <code>ef</code> means you consider more alternatives (better recall) but do more distance checks (higher latency).</p>
<p>Here‚Äôs a table of the 3 main parameters for HNWS graph and their impact on the usability:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Parameter</th>
<th>When</th>
<th>What it controls</th>
<th>Bigger means‚Ä¶</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>M</code></td>
<td>build time</td>
<td>max neighbors per node</td>
<td>higher memory, often better connectivity/recall</td>
</tr>
<tr class="even">
<td><code>ef_construction</code></td>
<td>build time</td>
<td>how hard the builder tries to find good edges</td>
<td>slower build, higher index quality</td>
</tr>
<tr class="odd">
<td><code>ef</code> / <code>hnsw_ef</code></td>
<td>query time</td>
<td>how wide the candidate shortlist is</td>
<td>higher latency, higher recall</td>
</tr>
</tbody>
</table>
</section>
<section id="why-the-hierarchy-matters" class="level3">
<h3 class="anchored" data-anchor-id="why-the-hierarchy-matters">Why the hierarchy matters</h3>
<p>The strategy above works on a single graph, but it can waste time wandering before it reaches the right region.</p>
<p>HNSW adds the <em>pick the right city first</em> step by using multiple layers for search.</p>
<ul>
<li>The higher layer is like a very coarse-grained map of the country, including details just about very few restaurant that are very far from each other.</li>
<li>The lowest layer of all is like the map of the whole country with all the details. It includes all the nodes of all previous layer.</li>
</ul>
<p>In general terms:</p>
<ul>
<li>upper layers contain fewer nodes with longer-range connections</li>
<li>lower layers contain more nodes with short-range connections</li>
</ul>
<p>When searching for the most similar nodes to your query, search is top-down.</p>
<ul>
<li>You start in the top layer, walk greedily to the most similar node you can find until you can‚Äôt improve</li>
<li>You drop to the next layer while keeping your current best node as the new starting point</li>
<li>You repeat until the bottom layer (which contains all nodes)</li>
</ul>
<p>The hierarchy is what makes the navigation both fast and surprisingly accurate.</p>
<div style="text-align: center;">
<p><img src="https://qdrant.tech/courses/day2/hnsw-layers.png" alt="HNSW greedy search visualization" style="max-width: 100%; height: auto;"></p>
</div>
<p style="text-align: center; font-style: italic; color: #666; margin-top: 5px;">
Source: <a href="https://qdrant.tech/courses/day2/hnsw-layers.png">Qdrant</a>
</p>
</section>
</section>
</section>
<section id="how-filtering-breaks-hnsw" class="level1">
<h1>2. How filtering breaks HNSW</h1>
<p>Vector search almost never happens in isolation as your users always want to combine similarity with metadata filters as in our earbuds example: <em>‚Äúfind wireless earbuds, but only from Apple or Google.‚Äù</em></p>
<p>Two obvious ways to filter come to mind (which are implemented widely in industry) but they both fail most of the time.</p>
<section id="the-post-filtering-method" class="level2">
<h2 class="anchored" data-anchor-id="the-post-filtering-method">The post-filtering method</h2>
<p>The naive approach: run HNSW to get the top-K most similar results, then throw away the ones that don‚Äôt match the filter.</p>
<p>The main reason this method fails is that your top K <em>wireless earbuds</em> results might be dominated by other brands. After discarding non-matching items, you‚Äôre <strong>left with almost nothing</strong>.</p>
<p>HNSW returned 5 results but only 1 matched the filter. Meanwhile, closer Apple/Google earbuds ranked beyond top K were never retrieved, so they could not be returned.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://chsafouane.github.io/posts/Why WHERE clauses can break your vector search/assets/post-filtering.png" class="img-fluid figure-img"></p>
<figcaption>Post-filtering diagram</figcaption>
</figure>
</div>
<p>In practice, you end up making <code>top k</code> higher (and usually the exploration budget <code>ef</code>) high enough that <em>some</em> filtered items make it into the candidate set, which defeats the whole purpose of ANN: you pay for extra work just to throw most of it away.</p>
</section>
<section id="the-pre-filtering-method" class="level2">
<h2 class="anchored" data-anchor-id="the-pre-filtering-method">The pre-filtering method</h2>
<p>The other option is to filter the dataset first and then search HNSW only among matching items.</p>
<p>While this method looks sound, it also fails‚Ä¶</p>
<p>The reason it fails is that the HNSW graph was built on <strong>all data</strong>. When you filter your dataset, you‚Äôre removing nodes from the graph, so many edges disappear. Paths between matching items often route <em>through</em> non-matching ones, and once those bridge nodes are gone, the graph falls apart.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://chsafouane.github.io/posts/Why WHERE clauses can break your vector search/assets/pre-filtering.png" class="img-fluid figure-img"></p>
<figcaption>Pre-filtering diagram</figcaption>
</figure>
</div>
<p>The path from Apple Earbuds to Google Earbuds went <em>through</em> Sony Earbuds. Remove non-matching brands, and Google Earbuds becomes <strong>unreachable</strong>. Your search silently misses it.</p>
<p>Even worse, if the HNSW entry point (or the early candidates in the queue) happen to be in the filtered-out region, the search may never reach the remaining component at all.</p>
<p>The HNSW graph‚Äôs connectivity depends on nodes that your filter removes. This isn‚Äôt an edge case ‚Äî it‚Äôs the common case for selective filters.</p>
<p>If you want real numbers on how many nodes you need to keep for a graph to remain connected, I highly recommend reading this short post on <a href="https://blog.vasnetsov.com/posts/categorical-hnsw/">HNSW &amp; percolation theory</a>. One caveat: percolation theory assumes <strong>random</strong> node removal. When filter values correlate with embedding position (e.g., all products of one brand cluster together), removal is <em>spatially correlated</em> ‚Äî you lose entire neighborhoods at once, which is far more destructive than the random case. The percolation thresholds in that post are optimistic for correlated filters.</p>
</section>
</section>
<section id="qdrants-solution-filterable-hnsw" class="level1">
<h1>3. Qdrant‚Äôs solution: filterable HNSW</h1>
<p>Not all vector databases/vector frameworks implement a solution for this problem. Many only implement pre-filtering or post-filtering.</p>
<p>Among the providers that <em>do</em> propose a solution, the approaches differ.</p>
<p>In this blog post, I focus on Qdrant‚Äôs solution because it is simple and effective.</p>
<p>The idea is to pre-build connected subgraphs for each filter value and merge their edges into the main graph.</p>
<section id="how-does-it-work-1" class="level2">
<h2 class="anchored" data-anchor-id="how-does-it-work-1">How does it work</h2>
<p>Filterable HNSW adds a small set of extra edges so filtering does not disconnect matching points.</p>
<p>Take a categorical field like <code>brand</code> with values <code>[Apple, Google, Sony]</code>. Qdrant:</p>
<ol type="1">
<li>Builds a connected mini-HNSW subgraph inside each brand. That way, the products of each brand become connected together.</li>
<li>Adds those subgraph edges to the main HNSW graph.</li>
</ol>
<p>This method guarantees that after filtering on brands, points that share the same brand will be connected (reachable from each other).</p>
<p>It‚Äôs very important to know that connectivity between <em>different</em> brands is not enforced by these subgraphs. Cross-brand connections rely on similarity links in the main graph, which may or may not survive filtering.</p>
<p>Let us look at an example to make this clear.</p>
<p>In the diagrams below:</p>
<ul>
<li>A, B, E are Apple points</li>
<li>C, D, G are Google</li>
<li>F, H, I are Sony</li>
</ul>
<p>Qdrant builds a graph for each one of the 3 brands.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://chsafouane.github.io/posts/Why WHERE clauses can break your vector search/assets/brand-subgraphs.png" class="img-fluid figure-img"></p>
<figcaption>Brand subgraphs diagram</figcaption>
</figure>
</div>
<p>Then these brand graphs are <strong>merged</strong> into the main graph. This is a key point: after the merge, there‚Äôs only <strong>one graph</strong> in memory containing both:</p>
<ul>
<li><strong>Similarity edges</strong> (from standard HNSW construction which connects nearby vectors using similarity)</li>
<li><strong>Subgraph edges</strong> (connecting nodes with the same value of the filter, e.g: brands)</li>
</ul>
<p>These aren‚Äôt stored separately. The subgraph edges are simply added to the existing graph structure at build time.</p>
<p>In the diagram below, all three brands sell similar products (earbuds, headphones, etc.), so their nodes are interleaved in embedding space. That‚Äôs why the main graph also has <strong>similarity edges across brands</strong> including direct Apple &lt;-&gt; Google links.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://chsafouane.github.io/posts/Why WHERE clauses can break your vector search/assets/merged-graph.png" class="img-fluid figure-img"></p>
<figcaption>Merged graph diagram</figcaption>
</figure>
</div>
<p><strong>After filtering</strong> with <code>brand IN ('Apple', 'Google')</code>, Sony points are removed. Brand subgraph edges keep each brand internally connected. But what about the connection <em>between</em> Apple and Google?</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://chsafouane.github.io/posts/Why WHERE clauses can break your vector search/assets/filtered-graph.png" class="img-fluid figure-img"></p>
<figcaption>Filtered graph diagram</figcaption>
</figure>
</div>
<p>In our example, because Apple and Google sell similar products, their nodes are close in embedding space. The direct Apple &lt;-&gt; Google similarity edges (A‚ÄìC, B‚ÄìG) survived the filter, so the search can still jump between brands.</p>
<p>But these cross-brand edges exist <em>because</em> the brands overlap in what they sell. If instead one brand only made luxury laptops and the other only budget wireless earbuds, their products would land in <strong>different regions</strong> of the embedding space and there would be very few or no similarity edges between them. In that case, after filtering, the search starts in one brand‚Äôs cluster and never reaches the other. That‚Äôs the pre-filtering failure mode all over again, just at a smaller scale.</p>
<p><strong>Keep this in mind:</strong> Filterable HNSW guarantees that <strong>all Apple products stay connected</strong> and <strong>all Google products stay connected</strong>. It does <strong>not</strong> guarantee that Apple products can reach Google products, this really depends on whether similarity edges bridge the gap, which depends on how correlated brand identity is with embedding position.</p>
<p>For single-value filters (e.g., <code>brand = 'Apple'</code>), this distinction doesn‚Äôt matter.</p>
</section>
<section id="does-the-memory-explode" class="level2">
<h2 class="anchored" data-anchor-id="does-the-memory-explode">Does the memory explode ?</h2>
<p>The memory usage is kept well under control with filterable HNSW</p>
<p>As each node belongs to exactly one brand,each node gains at most <code>m</code> additional edges from its brand subgraph, which makes the number of new edges at most <code>n * m</code>. Now, as you add more filters (not only the brand), you‚Äôre going to have additional edges built.</p>
</section>
<section id="the-query-planner" class="level2">
<h2 class="anchored" data-anchor-id="the-query-planner">The query planner</h2>
<p>At query time, Qdrant estimates <strong>filter selectivity</strong> and decides: <em>should I traverse this graph, or just brute-force?</em></p>
<ul>
<li><p><strong>High or medium selectivity</strong>: In this case, Qdrant just traverses the graph. The subgraph edges are always there and whether they‚Äôre <em>critical</em> depends on how many nodes the filter removes.</p>
<ul>
<li>With high selectivity (e.g, 70% match), most similarity edges still lead to valid nodes</li>
<li>With medium selectivity (e.g, 15% match), the subgraph edges become essential for maintaining connectivity.</li>
</ul></li>
<li><p><strong>Low selectivity (e.g, 0.1%)</strong>: Qdrant skips the graph entirely. When only a tiny fraction of nodes match, brute-force scanning over the filtered set is faster than graph traversal.</p></li>
</ul>
<p>The intuition: graph-based search only pays off when there‚Äôs enough connectivity to navigate. For very selective filters, there‚Äôs so little data left that exhaustive search wins.</p>
<p>Qdrant allows you to control this behavior using <code>full_scan_threshold</code>. When the filtered candidate count falls below <code>full_scan_threshold</code>, Qdrant automatically switches to brute-force scanning.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> qdrant_client.models <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> VectorParams, Distance, HnswConfigDiff</span>
<span id="cb1-2"></span>
<span id="cb1-3">client.create_collection(</span>
<span id="cb1-4">    collection_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"products"</span>,</span>
<span id="cb1-5">    vectors_config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>VectorParams(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">384</span>, distance<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Distance.COSINE),</span>
<span id="cb1-6">    hnsw_config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>HnswConfigDiff(</span>
<span id="cb1-7">        m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,</span>
<span id="cb1-8">        ef_construct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="cb1-9">        full_scan_threshold<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># switch to brute-force when fewer than 1k candidates match</span></span>
<span id="cb1-10">    )</span>
<span id="cb1-11">)</span></code></pre></div>
</section>
<section id="getting-it-right-in-practice-with-qdrant" class="level2">
<h2 class="anchored" data-anchor-id="getting-it-right-in-practice-with-qdrant">Getting it right in practice with Qdrant</h2>
<p>Two implementation details trip people up consistently.</p>
<section id="create-payload-indexes-explicitly" class="level3">
<h3 class="anchored" data-anchor-id="create-payload-indexes-explicitly">1. Create payload indexes explicitly</h3>
<p>Qdrant does not automatically index payload fields. Filtering still works without indexes ‚Äî you‚Äôll get correct results ‚Äî but you lose two critical optimizations:</p>
<ol type="1">
<li><strong>No subgraph edges</strong>: The HNSW graph won‚Äôt have the extra edges needed for filtered search, so you lose the connectivity guarantees described above.</li>
<li><strong>Poor cardinality estimation</strong>: The query planner can‚Äôt accurately estimate how many points match the filter, leading to suboptimal search strategies. I couldn‚Äôt find the exact way it determines the strategy in the documentation but as they‚Äôre also an open-source package, the curious minds can dive into their package to get this information.</li>
</ol>
</section>
<section id="create-indexes-before-uploading-data" class="level3">
<h3 class="anchored" data-anchor-id="create-indexes-before-uploading-data">2. Create indexes before uploading data</h3>
<p>The order matters. HNSW graphs only get the subgraph edges when they‚Äôre built <em>after</em> the payload index exists. If you upload data first, the HNSW graph gets built without them.</p>
<p>If you already uploaded data without indexes, you can still fix it but you‚Äôll need to force an HNSW rebuild, which is expensive for large collections.</p>
</section>
</section>
<section id="what-about-numerical-filters" class="level2">
<h2 class="anchored" data-anchor-id="what-about-numerical-filters">What about numerical filters?</h2>
<p>Everything above focused on categorical filters like <code>brand IN ('Apple', 'Google')</code>. But applications also filter on prices, ratings, timestamps, and other continuous values.</p>
<p>Qdrant supports three numerical index types: <code>integer</code>, <code>float</code> &amp; <code>datetime</code></p>
<section id="how-qdrant-handles-numerical-ranges" class="level3">
<h3 class="anchored" data-anchor-id="how-qdrant-handles-numerical-ranges">How Qdrant handles numerical ranges</h3>
<p>The <a href="https://qdrant.tech/articles/filterable-hnsw/">original filterable HNSW article</a> explains the approach:</p>
<blockquote class="blockquote">
<p>‚ÄúNumerical range case can be reduced to the previous one if we split numerical range into buckets containing equal amount of points. Next we also connect neighboring buckets to achieve graph connectivity.‚Äù</p>
</blockquote>
<p>Here‚Äôs how the mechanism works:</p>
<ol type="1">
<li><strong>Buckets contain equal amounts of points</strong> . If you have 10,000 products and 10 buckets, each bucket contains ~1,000 products regardless of how prices are distributed.</li>
<li><strong>Neighboring buckets are connected</strong> so range queries like products whose price in [150, 350]can traverse across boundaries.</li>
<li><strong>Border filtering is required</strong>: items in boundary buckets that don‚Äôt match the actual filter need post-filtering. For example, with a <code>price &lt; 150</code> filter, if bucket boundaries fall at $0, $100, $200, etc., the query would:
<ul>
<li>Traverse all buckets up to the one containing $150</li>
<li>Post-filter items in the boundary bucket to exclude those with price &gt;= $150</li>
</ul></li>
</ol>
<p>This works well in practice but isn‚Äôt as clean as the solution for categorical data.</p>
<p>And of course, you can always opt for bucketing the numerical filter data yourself as you might have a better knowledge of the data and of where the boundaries should go.</p>
</section>
</section>
</section>
<section id="conclusion" class="level1">
<h1>4. Conclusion</h1>
<p>There are really a couple of takeaways here:</p>
<ul>
<li>Vector search with filters doesn‚Äôt just work out of the box and is not just ‚Äúvector search + WHERE clause</li>
<li>Your Vector DB solution might not provide a solution for this, so do what any sound developer woud do, read the docs !</li>
</ul>
</section>
<section id="further-reading" class="level1">
<h1>5. Further reading</h1>
<ul>
<li><a href="https://qdrant.tech/documentation/concepts/filtering/">Qdrant Documentation: Filtering</a></li>
<li><a href="https://qdrant.tech/articles/filterable-hnsw/">Original Filterable HNSW Article by Qdrant</a></li>
<li><a href="https://arxiv.org/abs/1603.09320">HNSW Paper: Efficient and Robust Approximate Nearest Neighbor (Malkov &amp; Yashunin, 2016)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Percolation_theory">Percolation Theory ‚Äî Wikipedia</a></li>
</ul>


</section>

 ]]></description>
  <category>Python</category>
  <category>NLP</category>
  <category>vector search</category>
  <guid>https://chsafouane.github.io/posts/Why WHERE clauses can break your vector search/Why filtering can break your vector search.html</guid>
  <pubDate>Thu, 05 Feb 2026 23:00:00 GMT</pubDate>
  <media:content url="https://plus.unsplash.com/premium_photo-1681586126003-2a6d4ba943a2?q=80&amp;w=1112&amp;auto=format&amp;fit=crop&amp;ixlib=rb-4.1.0&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" medium="image"/>
</item>
<item>
  <title>Why does SwiGLU work ?</title>
  <dc:creator>Safouane Chergui</dc:creator>
  <link>https://chsafouane.github.io/posts/SwiGLU/All you need to know about SwiGLU.html</link>
  <description><![CDATA[ 





<p>The goal of this blog post is to explain why modern LLM architectures use <code>SwiGLU</code> as the activation function for the feed-forward part and have moved away from <code>ReLU</code>.</p>
<p><strong>Table of contents</strong><a id="toc0_"></a><br>
- Q1: Why do we need activation functions at all?<br>
- Q2: What‚Äôs wrong with ReLU?<br>
- Q3: What is the Swish activation function?<br>
- Q4: What are Gated Linear Units (GLU)?<br>
- Q5: What is SwiGLU then?<br>
- Final note</p>
<!-- vscode-jupyter-toc-config
    numbering=false
    anchor=true
    flat=false
    minLevel=1
    maxLevel=6
    /vscode-jupyter-toc-config -->
<!-- THIS CELL WILL BE REPLACED ON TOC UPDATE. DO NOT WRITE YOUR TEXT IN THIS CELL -->
<section id="q1-why-do-we-need-activation-functions-at-all" class="level1">
<h1><a id="toc1_"></a>Q1: Why do we need activation functions at all?</h1>
<p>Consider this: a neural network is essentially a series of matrix multiplications. If we stack linear layers without any activation function:</p>
<p><img src="https://latex.codecogs.com/png.latex?y%20=%20W_3(W_2(W_1%20x))"></p>
<p>This simplifies to:</p>
<p><img src="https://latex.codecogs.com/png.latex?y%20=%20(W_3%20W_2%20W_1)%20x%20=%20W_%7Bcombined%7D%20x"></p>
<p>No matter how many layers you stack, it‚Äôs still just a linear transformation. The network can only learn linear relationships.</p>
<p>Activation functions introduce <strong>non-linearity</strong>, allowing the network to approximate complex, non-linear functions. This is the foundation of deep learning‚Äôs expressive power.</p>
<p>Now, if you have a hard time mentally visualizing the impact of applying activation functions, I highly advise you to watch <a href="https://youtu.be/5_qrxVq1kvc?list=PL80I41oVxglKcAHllsU0txr3OuTTaWX2v&amp;t=1693">the section 3 of this video</a> from Alfredo Canziani‚Äôs Deep Learning course. It will help you build a great intuition!</p>
</section>
<section id="q2-whats-wrong-with-relu" class="level1">
<h1><a id="toc2_"></a>Q2: What‚Äôs wrong with ReLU?</h1>
<p><code>ReLU</code> literally revolutionized deep learning:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BReLU%7D(x)%20=%20%5Cmax(0,%20x)"></p>
<p>It‚Äôs simple, fast, and solves the vanishing gradient problem that is a problem with functions like <code>sigmoid</code> or <code>tanh</code>.</p>
<p>While people usually list problems that might be encountered when <code>ReLU</code> is used like the <em>dying neuron problem</em>, these problems are either theoritical or can be well managed most of the time with techniques used in neural networks nowadays (batch normalization, adaptive learning weights, etc)</p>
</section>
<section id="q3-what-is-the-swish-activation-function" class="level1">
<h1><a id="toc3_"></a>Q3: What is the Swish activation function?</h1>
<p>Now, before moving to SwiGLU, we‚Äôll look at an activation function <strong>Swish</strong> that is part of <strong>SwiGLU</strong></p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BSwish%7D(x)%20=%20x%20%5Ccdot%20%5Csigma(x)%20=%20%5Cfrac%7Bx%7D%7B1%20+%20e%5E%7B-x%7D%7D"></p>
<p>Swish is a ‚Äòself-gated‚Äô activation function: the input <img src="https://latex.codecogs.com/png.latex?x"> is multiplied by its own sigmoid <img src="https://latex.codecogs.com/png.latex?%5Csigma(x)">, which acts as a <strong>gate</strong> that controls how much of the input passes through.</p>
<p>Looking at how the gate behaves: - When <img src="https://latex.codecogs.com/png.latex?x"> is very negative: <img src="https://latex.codecogs.com/png.latex?%5Csigma(x)%20%5Capprox%200">, so the gate is <strong>closed</strong> (suppresses the output) - When <img src="https://latex.codecogs.com/png.latex?x"> is very positive: <img src="https://latex.codecogs.com/png.latex?%5Csigma(x)%20%5Capprox%201">, so the gate is <strong>fully open</strong> (passes the input through almost unchanged)</p>
<p>Despite the bit more complicated formula, <code>Swish</code> has a very similar behavior to <code>ReLU</code>.</p>
<div id="cell-9" class="cell" data-execution_count="27">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://chsafouane.github.io/posts/SwiGLU/All you need to know about SwiGLU_files/figure-html/cell-2-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="is-swish-better-than-relu" class="level3">
<h3 class="anchored" data-anchor-id="is-swish-better-than-relu"><a id="toc3_1_1_"></a>Is Swish better than ReLU?</h3>
<p>Empirically, <code>Swish</code> is found to work better than <code>ReLU</code> but like many things in deep learning, we don‚Äôt know for sure why <code>Swish</code> works better, but here are the key differences:</p>
<p><strong>1. No hard gradient cutoff</strong></p>
<p>Looking at the plot above, the key difference is how they handle negative inputs:</p>
<ul>
<li><strong>ReLU</strong>: Hard cutoff at zero
<ul>
<li>When <img src="https://latex.codecogs.com/png.latex?x%20%3C%200">: output = 0 &amp; gradient = 0 (exactly)</li>
<li>This is the dying neuron problem (though as mentioned in Q2, it‚Äôs often manageable with modern techniques like BatchNorm)</li>
</ul></li>
<li><strong>Swish</strong>: Smooth, gradual approach to zero
<ul>
<li>For negative <img src="https://latex.codecogs.com/png.latex?x">: gradient approaches zero asymptotically but never exactly hits zero for finite values</li>
<li>Neurons can theoretically always receive updates (though updates may be negligible for very negative inputs)</li>
</ul></li>
</ul>
<p><strong>2. Smoothness</strong></p>
<p><code>ReLU</code> has a discontinuity at <img src="https://latex.codecogs.com/png.latex?x%20=%200"> (derivative jumps from 0 to 1). <code>Swish</code> is infinitely differentiable everywhere, which means that the gradient landscape is smooth. Whether this smoothness contributes to the performance of <code>Swish</code> is not 100% clear but it‚Äôs plausible that this helps with optimization</p>
<div id="cell-11" class="cell" data-execution_count="28">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://chsafouane.github.io/posts/SwiGLU/All you need to know about SwiGLU_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="q4-what-are-gated-linear-units-glu" class="level1">
<h1><a id="toc4_"></a>Q4: What are Gated Linear Units (GLU)?</h1>
<p>Now, this is our last component before getting to <code>SwiGLU</code>. Let‚Äôs talk about <strong>GLU</strong>.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BGLU%7D(x,%20W,%20V,%20b,%20c)%20=%20(xW%20+%20b)%20%5Codot%20%5Csigma(xV%20+%20c)"></p>
<p>Where: - <img src="https://latex.codecogs.com/png.latex?x"> is the input - <img src="https://latex.codecogs.com/png.latex?W,%20V"> are weight matrices - <img src="https://latex.codecogs.com/png.latex?b,%20c"> are bias vectors - <img src="https://latex.codecogs.com/png.latex?%5Codot"> is element-wise multiplication - <img src="https://latex.codecogs.com/png.latex?%5Csigma"> is the sigmoid function</p>
<p>The first thing that you should note is that <code>GLU</code> uses a gating mechanism and is somehow similar to <code>Swish</code> in that manner. The difference is that instead of applying the same transformation (identity) to all features and then gating with a fixed function (sigmoid), GLU uses two separate linear projections:</p>
<ol type="1">
<li><img src="https://latex.codecogs.com/png.latex?xW%20+%20b">: this just takes the input &amp; transforms it. It is usually called the <em>content path</em></li>
<li><img src="https://latex.codecogs.com/png.latex?%5Csigma(xV%20+%20c)">: this second part says how much of the content of each feature should pass through and for that, it‚Äôs called the <em>gate path</em></li>
</ol>
<p>So, <code>GLU</code> can really be thought of as a generalization fo <code>Swish</code></p>
<section id="why-is-multiplicative-gating-powerful" class="level3">
<h3 class="anchored" data-anchor-id="why-is-multiplicative-gating-powerful"><a id="toc4_1_1_"></a>Why is multiplicative gating powerful?</h3>
<p>The element-wise multiplication <img src="https://latex.codecogs.com/png.latex?%5Codot"> allows <em>the gate</em> to select which element of <em>the content</em> to let pass through. The gate can completely suppress certain features (when <img src="https://latex.codecogs.com/png.latex?%5Csigma(xV%20+%20c)%20%5Capprox%200">) while fully passing through others (when <img src="https://latex.codecogs.com/png.latex?%5Csigma(xV%20+%20c)%20%5Capprox%201">).</p>
</section>
<section id="concrete-example-of-gating" class="level3">
<h3 class="anchored" data-anchor-id="concrete-example-of-gating"><a id="toc4_1_2_"></a>Concrete example of gating</h3>
<p>let suppose we have a 4-dim vector <img src="https://latex.codecogs.com/png.latex?x"></p>
<p><img src="https://latex.codecogs.com/png.latex?x%20=%20%5B1.0,%20-0.5,%202.0,%200.3%5D"></p>
<p>GLU applies 2 transformations to this same input:</p>
<ol type="1">
<li>A transformation to the content through the content path: <img src="https://latex.codecogs.com/png.latex?xW%20+%20b">. Let us say that it produces <img src="https://latex.codecogs.com/png.latex?%5B2.0,%20-1.5,%203.0,%200.5%5D"></li>
<li>A 2nd transformation that‚Äôs supposed to play the role of the gate: <img src="https://latex.codecogs.com/png.latex?%5Csigma(xV%20+%20c)">. Let us say that it produces <img src="https://latex.codecogs.com/png.latex?%5B0.9,%200.1,%200.95,%200.05%5D"></li>
</ol>
<p>The GLU output is their element-wise product:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BGLU%20output%7D%20=%20%5B2.0%20%5Ctimes%200.9,%20%5C;%5C;%20-1.5%20%5Ctimes%200.1,%20%5C;%5C;%203.0%20%5Ctimes%200.95,%20%5C;%5C;%200.5%20%5Ctimes%200.05%5D"> <img src="https://latex.codecogs.com/png.latex?=%20%5B1.8,%20%5C;%5C;%20-0.15,%20%5C;%5C;%202.85,%20%5C;%5C;%200.025%5D"></p>
<p>This means that: - <strong>Feature 1</strong>: Content is positive (2.0), gate is high (0.9) ‚Üí passes through strongly (1.8) - <strong>Feature 2</strong>: Content is negative (-1.5), gate is low (0.1) ‚Üí blocked (-0.15) - <strong>Feature 3</strong>: Content is positive (3.0), gate is very high (0.95) ‚Üí fully passes (2.85) - <strong>Feature 4</strong>: Content is small (0.5), gate is very low (0.05) ‚Üí suppressed (0.025)</p>
<p>This allows the network to learn complex decision rules: ‚Äúfor inputs like <img src="https://latex.codecogs.com/png.latex?x">, amplify feature 1 and 3, but suppress features 2 and 4.‚Äù</p>
<div id="cell-15" class="cell" data-execution_count="29">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://chsafouane.github.io/posts/SwiGLU/All you need to know about SwiGLU_files/figure-html/cell-4-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="q5-what-is-swiglu-then" class="level1">
<h1><a id="toc5_"></a>Q5: What is SwiGLU then?</h1>
<p>Now we have all the pieces. <code>SwiGLU</code> (Swish-Gated Linear Unit) simply combines Swish and GLU:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BSwiGLU%7D(x,%20W,%20V)%20=%20%5Ctext%7BSwish%7D(xW)%20%5Codot%20xV"></p>
<p>That‚Äôs it. Instead of using sigmoid for the gate (like in GLU), it uses Swish. That‚Äôs why it‚Äôs called <strong>Swi</strong>sh + <strong>GLU</strong>.</p>
<p>So what does each part of the formula do ? Well, it‚Äôs exactly the same logic as GLU as what changes is just the gating function.</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BSwish%7D(xW)">: The <strong>gate</strong> - decides how much of each feature passes through</li>
<li><img src="https://latex.codecogs.com/png.latex?xV">: The <strong>content</strong> - the actual information being transmitted</li>
<li><img src="https://latex.codecogs.com/png.latex?%5Codot">: Element-wise multiplication - applies the gate to the content</li>
</ul>
<div id="cell-18" class="cell" data-execution_count="36">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://chsafouane.github.io/posts/SwiGLU/All you need to know about SwiGLU_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="why-does-swiglu-work-so-well" class="level3">
<h3 class="anchored" data-anchor-id="why-does-swiglu-work-so-well"><a id="toc5_1_1_"></a>Why does SwiGLU work so well?</h3>
<p>Empirically, SwiGLU outperforms other activation functions in LLMs (even though not sure about VLMs for now). But why? Here‚Äôs the intuition:</p>
<p><strong>1. Multiplicative interactions create feature combinations</strong></p>
<p>This is the key insight. Consider what each architecture computes:</p>
<p><strong>Standard FFN</strong> (ReLU/GELU): <code>output = activation(xW‚ÇÅ) @ W‚ÇÇ</code></p>
<p>Each output dimension is a weighted sum of activated features. The activation is applied <em>element-wise</em>, this means that the features don‚Äôt interact with each other inside the activation.</p>
<p><strong>SwiGLU FFN</strong>: <code>output = (Swish(xW) ‚äô xV) @ W‚ÇÇ</code></p>
<p>The element-wise multiplication <img src="https://latex.codecogs.com/png.latex?%5Codot"> creates <strong>products between the two paths</strong>. If we denote <img src="https://latex.codecogs.com/png.latex?g%20=%20%5Ctext%7BSwish%7D(xW)"> and <img src="https://latex.codecogs.com/png.latex?c%20=%20xV">, then output dimension <img src="https://latex.codecogs.com/png.latex?i"> before the final projection is <img src="https://latex.codecogs.com/png.latex?g_i%20%5Ctimes%20c_i">.</p>
<p>Here‚Äôs why this matters: both <img src="https://latex.codecogs.com/png.latex?g_i"> and <img src="https://latex.codecogs.com/png.latex?c_i"> are linear combinations of input features (before the Swish). Their product contains <strong>cross-terms</strong> like <img src="https://latex.codecogs.com/png.latex?x_j%20%5Ctimes%20x_k">. The network can learn <img src="https://latex.codecogs.com/png.latex?W"> and <img src="https://latex.codecogs.com/png.latex?V"> such that certain input feature combinations are amplified or suppressed.</p>
<p>This is similar to why attention is powerful. Attention computes <img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bsoftmax%7D(QK%5ET)V">, where the <img src="https://latex.codecogs.com/png.latex?QK%5ET"> product captures interactions between query and key features. SwiGLU brings a similar multiplicative expressiveness to the FFN.</p>
<p><strong>2. Why not use sigmoid in the gate instead of Swish?</strong></p>
<p>GLU uses sigmoid: <img src="https://latex.codecogs.com/png.latex?%5Csigma(xW)%20%5Codot%20xV">. The problem with the <code>sigmoid</code> is that it saturate saturates. For large positive or negative inputs, <img src="https://latex.codecogs.com/png.latex?%5Csigma(x)%20%5Capprox%201"> or <img src="https://latex.codecogs.com/png.latex?%5Csigma(x)%20%5Capprox%200">, and the gradient <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Cpartial%20%5Csigma%7D%7B%5Cpartial%20x%7D%20%5Capprox%200">. The gate becomes frozen.</p>
<p>Swish doesn‚Äôt saturate for positive inputs, it grows approximately linearly (just like <code>ReLU</code>). This implies that: - Gradients flow better through the gate path - The gate can modulate rather than just switch on/off</p>
<p><strong>3. smoothness</strong></p>
<p>Another thing is that SwiGLU is infinitely differentiable &amp; this smoothness likely helps optimization stability.</p>
</section>
</section>
<section id="final-note" class="level1">
<h1><a id="toc6_"></a>Final note</h1>
<p>SwiGLU‚Äôs power comes from its <strong>gating mechanism</strong> &amp; <strong>multiplicative interactions</strong>. By splitting the input into two paths and multiplying them, the network can learn which feature combinations matter (which is quite similar to how attention captures interactions through <img src="https://latex.codecogs.com/png.latex?QK%5ET">).</p>
<p>Combined with Swish‚Äôs non-saturating gradients, this makes SwiGLU particularly effective for large models.</p>


</section>

 ]]></description>
  <category>Python</category>
  <category>NLP</category>
  <category>Deep Learning</category>
  <guid>https://chsafouane.github.io/posts/SwiGLU/All you need to know about SwiGLU.html</guid>
  <pubDate>Tue, 13 Jan 2026 23:00:00 GMT</pubDate>
</item>
<item>
  <title>Stop Vibe-Checking: Real-World Lessons on LLM Evals</title>
  <dc:creator>Safouane Chergui</dc:creator>
  <link>https://chsafouane.github.io/posts/LLM evaluation/LLM evaluation.html</link>
  <description><![CDATA[ 





<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Deploying LLM-powered systems in production is the easy part. The hard part? Making sure they‚Äôre actually working.</p>
<p>I‚Äôve been deploying LLM-powered systems in production in many companies and across different industries for almost 3 years now. Each time, I encountered the same critical challenge: <strong>how do you truly evaluate whether your LLM is performing well and not only rely on vibe checks ?</strong></p>
<p>If you‚Äôre struggling to move beyond ‚Äúit looks good to me‚Äù when evaluating your LLM applications, this blog post is for you.</p>
<br><br>
<div data-align="center">
<p><img src="https://chsafouane.github.io/posts/LLM evaluation/assets/front_image.jpg" width="80%" style="display: block; margin: 0 auto;"></p>
</div>
<p><br></p>
<p>This blog post contains lessons learnt through hands-on experience. These lessons come mostly from my experience testing what I have learnt in deploying real-life LLM applications, talking with peers, doing courses, and reading blog posts.</p>
<p>Apart from my personal experience, <a href="https://www.linkedin.com/in/hamelhusain/">Hamel Husain</a> &amp; <a href="https://www.linkedin.com/in/shrshnk/">Shreya Shankar</a> both <a href="https://maven.com/parlance-labs/evals">course</a> &amp; blogs on LLM evaluation have been of a great help to me and many of the techniques I discuss here are either directly quoted from their work or highly inspired by it.</p>
<p>Each of the lessons below will tackle a specific part of building and evaluating real LLM applications.</p>
</section>
<section id="pre-lesson" class="level1">
<h1>Pre-lesson</h1>
<p>I can‚Äôt emphasize this enough and even though you‚Äôve probably heard it a million times before, I‚Äôll have to say it: <strong>KNOW YOUR PRODUCT AND YOUR USERS</strong>.</p>
<p>If you don‚Äôt know your users and your product well, you won‚Äôt be able to understand the different ways they‚Äôll interact with your system, the different types of queries they‚Äôll make, and the different ways they can express the same intent. This is going to be a major obstacle whether you want to create synthetic data, to create evaluation metrics, or to interpret the results of your evaluations.</p>
<p>Now that this is said, let‚Äôs dive into the lessons!</p>
</section>
<section id="lesson-1-ill-vibe-check-my-app" class="level1">
<h1>Lesson 1: I‚Äôll vibe-check my app</h1>
<p>Here‚Äôs a common scenario I‚Äôve encountered many times: a company builds a RAG system over their product documentation, and naturally wants to evaluate and improve it. But there‚Äôs a pattern I keep seeing so often, companies expecting AI to ‚Äújust work‚Äù out of the box.</p>
<p>This expectation shows up most clearly in evaluation practices. Companies often use ‚Äúvibe checks‚Äù by manually asking a dozen of questions and eyeballing whether the system answers seem reasonable.</p>
<p>This is a terrible way to evaluate your LLM applications for multiple reasons:</p>
<ul>
<li><p>The queries you‚Äôre going to ask are biased towards what you think the system should be able to do or towards a specific range of queries that you expect the final user to enter. You will likely miss most of the cases and failure modes that you didn‚Äôt think about. From first-hand experience, the users usually will surprise you with the way they write their queries and the types of queries they will enter. You should expect them to write them as if they are in a rush üòÖ</p></li>
<li><p>Not having evaluated your app in a systematic and/or scalable way will lead to have to deal with ‚Äúwhack-a-mole‚Äù situation (as Hamel so beautifully puts it) where you fix one by changing some prompt only to have another one pop up somewhere else. This will lead to frustration from your stakeholders, frustration from the team working on the app, and maybe even to a a lack of trust in LLMs whithin your organization.</p></li>
</ul>
<div data-align="center">
<p><img src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExdm55dDYxNHd5eHdmYzlnZmJnMTg4OHRvb2x4ZWQ4bHVnZzQ2am9waiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/ebITvSXYKNvRm/giphy.gif" width="20%" style="display: block; margin: 0 auto;"></p>
</div>
<p><br></p>
</section>
<section id="lesson-2-i-dont-have-any-data-to-test-my-application-where-do-i-start" class="level1">
<h1>Lesson 2: I don‚Äôt have any data to test my application, where do I start ?</h1>
<p>Once you develop your LLM-powered app, you are faced with <strong>‚ÄúWhich comes first, the chicken or the egg?‚Äù</strong> dilemma:</p>
<ul>
<li>You don‚Äôt have real user queries data because you haven‚Äôt deployed you app yet</li>
<li>You can‚Äôt deploy your app yet because you haven‚Äôt tested it with real user queries yet</li>
</ul>
<section id="sub-lesson-1-real-data-is-better-than-synthetic-data" class="level2">
<h2 class="anchored" data-anchor-id="sub-lesson-1-real-data-is-better-than-synthetic-data">Sub-lesson 1: Real data is better than synthetic data</h2>
<p>You can almost always get some pseudo-real data. If you can‚Äôt have access to some beta users, ask your teammates to test the system. They will have very probably some biases of their own, but at least you will get some data that is not completely synthetic and that has different characteristics because it‚Äôs coming from different people.</p>
</section>
<section id="sub-lesson-2-the-bad-way-to-create-synthetic-data" class="level2">
<h2 class="anchored" data-anchor-id="sub-lesson-2-the-bad-way-to-create-synthetic-data">Sub-lesson 2: The bad way to create synthetic data</h2>
<p>Real data is always better than synthetic data. But hey, if you really can‚Äôt have some real data, then synthetic data is the way to go.</p>
<p>The mistake most people do when creating synthetic data is to ask an LLM to generate queries that are similar to what they expect the users to enter. This is a also a bad idea as the generated queries will be biased towards what you think the users will enter and will likely miss many failure modes. Most importantly, the generated queries will likely be ‚Äútoo good‚Äù and not representative of real user queries (messy, mispellings, incomplete‚Ä¶).</p>
<p>I‚Äôve trained a retriever in the past on synthetic data generated this way. While the performance on synthetic-queries-like was really good, the performance on real user queries was really bad. The gap between synthetic data and real user data was just too big.</p>
</section>
<section id="sub-lesson-3-the-good-way-to-create-synthetic-data" class="level2">
<h2 class="anchored" data-anchor-id="sub-lesson-3-the-good-way-to-create-synthetic-data">Sub-lesson 3: The good way to create synthetic data</h2>
<ul>
<li><p><em>Think of dimensions of variability of user queries:</em> An approach that I have learnt from Hamel Husain &amp; Shreya Shankar is to first think about the different dimensions of variability in user queries for your specific application. For example, if you‚Äôre building a RAG over a technical product documentation, you can think about several dimensions of variability, such as:</p></li>
<li><p>User type (user, admin, developer, etc.)</p></li>
<li><p>Intent (seeking information, troubleshooting, feature requests, etc.)</p></li>
<li><p>User expertise level (beginner, intermediate, expert, etc.)</p></li>
<li><p>Query length (short queries, long queries, etc.)</p></li>
<li><p>Query complexity (simple queries, complex queries with multiple sub-questions, etc.)</p></li>
<li><p>Query style (formal, informal, typos, etc.)</p></li>
<li><p>etc.</p></li>
</ul>
<p>As a query always depends on the context of the application and the persona of the users (a wink üòâ to the pre-lesson above), a dimension should be really specific to your application and not some general dimensions that someone else has used in another context.</p>
<p>Then, for each dimension, you can brainstorm different values that the dimension can take (or delegate the task of brainstorming values of some dimensions to an LLM). For example, for the ‚Äúuser expertise level‚Äù dimension, you can have the values: ‚Äúbeginner‚Äù, ‚Äúintermediate‚Äù, ‚Äúexpert‚Äù as shown above.</p>
<p>Once the list of dimensions and their possible values is ready, you can start combining them to create tuples that will represent different synthetic queries.</p>
<p>Here are some examples of tuples representing combinations of the dimensions mentioned above.</p>
<pre><code>("end_user", "troubleshoot", "beginner", "short", "simple", "typos")
("developer", "integration_info", "expert", "long", "complex", "formal")
("admin", "permissions_help", "intermediate", "short", "simple", "informal")
("end_user", "feature_discovery", "beginner", "short", "simple", "incomplete")
("support_engineer", "root_cause_analysis", "expert", "long", "complex", "dense")
("end_user", "account_status", "beginner", "short", "simple", "mixed_case")
("developer", "performance_optimization", "expert", "medium", "complex", "typos")
("admin", "audit_logging", "intermediate", "medium", "moderate", "formal")
("end_user", "error_meaning", "beginner", "short", "simple", "abbreviations")</code></pre>
<p>Each tuple becomes a prompt seed you can use to generate multiple queries from üöÄ</p>
<p>And here you have it, asystematic way to create synthetic data that covers a wide range of possible user queries for your specific application</p>
</section>
</section>
<section id="lesson-3-have-a-systematic-way-to-identify-failure-modes" class="level1">
<h1>Lesson 3: Have a systematic way to identify failure modes</h1>
<p>When you start evaluating your LLM applications, you need to have a systematic way to identify failure modes. Not having a systematic way to identify failure modes will lead you to the same ‚Äúwhack-a-mole‚Äù situation mentioned earlier where you fix one failure mode only to have another one pop up somewhere else.</p>
<p>You can identify failure modes using synthetic data (created as explained in Lesson 2) or real user queries (if you have access to them) even before deploying your app in production.</p>
<section id="sub-lesson-1-the-three-steps-for-error-analysis" class="level2">
<h2 class="anchored" data-anchor-id="sub-lesson-1-the-three-steps-for-error-analysis">Sub-lesson 1: The three steps for error analysis</h2>
<p>In short, the steps are: - Generate your system‚Äôs anwsers for the queries that you have (real or synthetic). Gather the traces of the execution for each query. - Open-coding: Note down the first failure that appears in the trace for each query (if present) - Axial coding: Cluster the failures into families of failure modes.</p>
<p>This three steps are the key to a successful error analysis. Since I‚Äôve discovered this approach in Hamel &amp; Shreya‚Äôs course, it has become my go-to approach for identifying failure modes in LLM applications in a systematic way.</p>
<section id="traces-are-king" class="level3">
<h3 class="anchored" data-anchor-id="traces-are-king">Traces are king</h3>
<p>A trace is a detailed log of the execution of your LLM application for a query. It includes all the intermediate steps, LLM calls, tool calls, and final output.</p>
<p>Well, now that you have a set of user queries (either real or synthetic), input each query through your LLM application and generate the whole trace of the execution. The trace should include all the intermediate steps, LLM calls, tool calls, and final output.</p>
<p>You should go through a good number of queries to cover the diversity of your queries (usually around a 100 but really depends on the complexity of your application and the diversity of your user queries, could be more or could be less than a 100).</p>
</section>
<section id="open-coding" class="level3">
<h3 class="anchored" data-anchor-id="open-coding">Open-coding</h3>
<p>Once you have the traces, go through each trace one by one and note down the first failure that appears in the trace for each query (if present). The description of the failure should be a bit specific. For example, you can say ‚ÄúDidn‚Äôt call the <code>call_customer_tool</code> even though the customer asked the system to do so‚Äù.</p>
</section>
<section id="axial-coding" class="level3">
<h3 class="anchored" data-anchor-id="axial-coding">Axial coding</h3>
<p>Now that you have annoatated the failures in your dataset, the next step is to put them into clusters of failure modes. You can do: - this manually by going through the list of failures and grouping them into families of failure modes - using an LLM to help you with the clustering. You can provide the LLM with the list of failures and ask it to group them into families of failure modes. This is usually my starting point as it saves a lot of time. Then, I go through the clusters and refine them if needed.</p>
<p>Now, here‚Äôs a diagram that summarizes this 3-step process:</p>
<div class="cell" data-fig-width="6" data-fig-height="5" data-layout-align="center">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="576" height="480" viewbox="0.00 0.00 212.51 338.92" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 334.92)">
<title>ErrorAnalysis</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-334.92 208.51,-334.92 208.51,4 -4,4"></polygon>
<!-- Start -->
<g id="node1" class="node">
<title>Start</title>
<ellipse fill="#e6f3ff" stroke="#0066cc" stroke-width="2" cx="128.78" cy="-297.26" rx="75.95" ry="33.82"></ellipse>
<text text-anchor="middle" x="128.78" y="-307.16" font-family="Arial" font-size="11.00">Start:</text>
<text text-anchor="middle" x="128.78" y="-293.96" font-family="Arial" font-size="11.00">Collect Queries</text>
<text text-anchor="middle" x="128.78" y="-280.76" font-family="Arial" font-size="11.00">(Real or Synthetic)</text>
</g>
<!-- Step1 -->
<g id="node2" class="node">
<title>Step1</title>
<path fill="#fff9e6" stroke="black" d="M141.36,-226.4C141.36,-226.4 12.21,-226.4 12.21,-226.4 6.21,-226.4 0.21,-220.4 0.21,-214.4 0.21,-214.4 0.21,-191.2 0.21,-191.2 0.21,-185.2 6.21,-179.2 12.21,-179.2 12.21,-179.2 141.36,-179.2 141.36,-179.2 147.36,-179.2 153.36,-185.2 153.36,-191.2 153.36,-191.2 153.36,-214.4 153.36,-214.4 153.36,-220.4 147.36,-226.4 141.36,-226.4"></path>
<text text-anchor="middle" x="76.78" y="-212.7" font-family="Arial" font-size="11.00">1. Generate Traces</text>
<text text-anchor="middle" x="76.78" y="-199.5" font-family="Arial" font-size="11.00">Run queries through system</text>
<text text-anchor="middle" x="76.78" y="-186.3" font-family="Arial" font-size="11.00">Capture execution steps</text>
</g>
<!-- Start&#45;&gt;Step1 -->
<g id="edge1" class="edge">
<title>Start-&gt;Step1</title>
<path fill="none" stroke="black" d="M110.89,-264.44C105.65,-255.12 99.91,-244.92 94.67,-235.6"></path>
<polygon fill="black" stroke="black" points="97.58,-233.63 89.63,-226.63 91.48,-237.06 97.58,-233.63"></polygon>
</g>
<!-- Step2 -->
<g id="node3" class="node">
<title>Step2</title>
<path fill="#e6ffe6" stroke="black" d="M136.61,-132C136.61,-132 46.96,-132 46.96,-132 40.96,-132 34.96,-126 34.96,-120 34.96,-120 34.96,-96.8 34.96,-96.8 34.96,-90.8 40.96,-84.8 46.96,-84.8 46.96,-84.8 136.61,-84.8 136.61,-84.8 142.61,-84.8 148.61,-90.8 148.61,-96.8 148.61,-96.8 148.61,-120 148.61,-120 148.61,-126 142.61,-132 136.61,-132"></path>
<text text-anchor="middle" x="91.78" y="-118.3" font-family="Arial" font-size="11.00">2. Open-Coding</text>
<text text-anchor="middle" x="91.78" y="-105.1" font-family="Arial" font-size="11.00">Annotate first failure</text>
<text text-anchor="middle" x="91.78" y="-91.9" font-family="Arial" font-size="11.00">in each trace</text>
</g>
<!-- Step1&#45;&gt;Step2 -->
<g id="edge2" class="edge">
<title>Step1-&gt;Step2</title>
<path fill="none" stroke="black" d="M80.49,-178.96C82.28,-167.96 84.45,-154.57 86.41,-142.49"></path>
<polygon fill="black" stroke="black" points="89.92,-142.73 88.07,-132.3 83.01,-141.61 89.92,-142.73"></polygon>
</g>
<!-- Step3 -->
<g id="node4" class="node">
<title>Step3</title>
<path fill="#ffe6f0" stroke="black" d="M183.16,-47.4C183.16,-47.4 90.41,-47.4 90.41,-47.4 84.41,-47.4 78.41,-41.4 78.41,-35.4 78.41,-35.4 78.41,-12.2 78.41,-12.2 78.41,-6.2 84.41,-0.2 90.41,-0.2 90.41,-0.2 183.16,-0.2 183.16,-0.2 189.16,-0.2 195.16,-6.2 195.16,-12.2 195.16,-12.2 195.16,-35.4 195.16,-35.4 195.16,-41.4 189.16,-47.4 183.16,-47.4"></path>
<text text-anchor="middle" x="136.78" y="-33.7" font-family="Arial" font-size="11.00">3. Axial Coding</text>
<text text-anchor="middle" x="136.78" y="-20.5" font-family="Arial" font-size="11.00">Cluster failures into</text>
<text text-anchor="middle" x="136.78" y="-7.3" font-family="Arial" font-size="11.00">failure mode families</text>
</g>
<!-- Step2&#45;&gt;Step3 -->
<g id="edge3" class="edge">
<title>Step2-&gt;Step3</title>
<path fill="none" stroke="black" d="M104.32,-84.39C109,-75.8 114.4,-65.88 119.44,-56.64"></path>
<polygon fill="black" stroke="black" points="122.61,-58.14 124.32,-47.69 116.46,-54.79 122.61,-58.14"></polygon>
</g>
<!-- Step3&#45;&gt;Start -->
<g id="edge4" class="edge">
<title>Step3-&gt;Start</title>
<path fill="none" stroke="#0066cc" stroke-width="2" d="M146.53,-47.66C150.76,-58.63 155.31,-72.08 157.78,-84.6 160.85,-100.11 168.25,-202.94 162.78,-226.6 160.56,-236.23 156.81,-246.08 152.6,-255.21"></path>
<polygon fill="#0066cc" stroke="#0066cc" stroke-width="2" points="149.33,-253.92 148.08,-264.44 155.62,-257 149.33,-253.92"></polygon>
<text text-anchor="middle" x="177.54" y="-152.9" font-family="Arial" font-size="9.00">Iterate</text>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="what-comes-next" class="level3">
<h3 class="anchored" data-anchor-id="what-comes-next">What comes next ?</h3>
<p><strong>Prioritization:</strong> Now having these clusters of failure modes will help you identify which exact parts of your system are responsible for failures and will help quantify how many failures are due to each failure mode.</p>
<p><strong>Iteration:</strong> Once you have identified the failure modes and prioritized them, you can start working on fixing them. After fixing them, you can go through the same process again to identify new failure modes that are still there. It‚Äôs very important to know that error analysis is an iterative process. You need to do it two or three times at first.</p>
</section>
<section id="scale-your-evals-in-production" class="level3">
<h3 class="anchored" data-anchor-id="scale-your-evals-in-production">Scale your evals in production</h3>
<p>You might ask yourself if you‚Äôll be doing this manually over production data to verify if th? The answer is that once you have a good understanding of the failure modes and have fixed the most critical ones, you can scale your evaluation by running a custom LLM-as-a-judge for large samples of queries that you have in prod.</p>
<p>Here‚Äôs how to do it: - Get the traces that you‚Äôve labeled previously with successful and failed queries &amp; split them into a train, a dev and a test set.</p>
<ul>
<li>Create a custom LLM-as-a-judge for each failure mode:
<ul>
<li>For each failure mode, create a prompt that describes the failure mode in a very specific way. Don‚Äôt be broad in your description and don‚Äôt use vague word (like good, etc). and provides examples of successful and failed queries from your labeled dataset.</li>
<li>Provide the LLM with example of both successful and failed queries from your train dataset to help it understand the failure mode better.</li>
<li>Eval the performance of the LLM-as-a-judge on your dev set and iterate on the prompt until you reach a satisfactory performance</li>
<li>Once you‚Äôre satisfied with the performance on the dev set, test the LLM-as-a-judge on your test set to get an estimate of its performance on unseen data. This should give you a good idea of how well the LLM-as-a-judge will perform on production data.</li>
</ul></li>
</ul>
<p>Now, this LLM-as-a-judge can be used to evaluate large samples of production queries and identify the failure modes that are still present in your system.</p>
</section>
</section>
<section id="sub-lesson-2-clustering-production-queries-didnt-work-for-me" class="level2">
<h2 class="anchored" data-anchor-id="sub-lesson-2-clustering-production-queries-didnt-work-for-me">Sub-lesson 2: Clustering production queries didn‚Äôt work for me</h2>
<p>One approach that I‚Äôve tested in the past (amounts to 1 year) and that didn‚Äôt work that well for me is to identify a set of classes that I expect user queries in my app to fall into. Identifying the classes helps in knowing which queries the model is not handling well and which classes of queries need more attention.</p>
<p>On top of the identified classes, I would create a category for ‚Äúother‚Äù queries that don‚Äôt fall into any of the identified classes. an analysis of the queries that have fallen into the ‚Äúother‚Äù category helped me identify new classes that I hadn‚Äôt thought about initially and better pinpoint the analysis of the performance of the model on different types of queries.</p>
<p>At the time, I used GPT-4 to do the classification. What didn‚Äôt work well for me was most queries ended up in the ‚Äúother‚Äù category, defeating the purpose of the classification. This pattern showed up with a couple of other decoder LLMs.</p>
<p>While I thought about finetuning a Bert-like model to do the classification, having to finetune a new model whenever a new class is identified seemed like an overkill and a maintenance nightmare.</p>
<div class="cell" data-fig-width="6" data-fig-height="8" data-layout-align="center">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="576" height="768" viewbox="0.00 0.00 217.75 488.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 484)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-484 213.75,-484 213.75,4 -4,4"></polygon>
<!-- Start -->
<g id="node1" class="node">
<title>Start</title>
<path fill="#e6f3ff" stroke="#0066cc" stroke-width="2" d="M154.53,-480C154.53,-480 55.56,-480 55.56,-480 49.56,-480 43.56,-474 43.56,-468 43.56,-468 43.56,-456 43.56,-456 43.56,-450 49.56,-444 55.56,-444 55.56,-444 154.53,-444 154.53,-444 160.53,-444 166.53,-450 166.53,-456 166.53,-456 166.53,-468 166.53,-468 166.53,-474 160.53,-480 154.53,-480"></path>
<text text-anchor="middle" x="105.05" y="-465.3" font-family="Arial" font-size="11.00">Define Query Classes</text>
<text text-anchor="middle" x="105.05" y="-452.1" font-family="Arial" font-size="11.00">+ 'Other' Category</text>
</g>
<!-- Classify -->
<g id="node2" class="node">
<title>Classify</title>
<polygon fill="#fff9e6" stroke="black" points="105.05,-406.9 24.44,-372.6 105.05,-338.3 185.65,-372.6 105.05,-406.9"></polygon>
<text text-anchor="middle" x="105.05" y="-375.9" font-family="Arial" font-size="11.00">GPT-4</text>
<text text-anchor="middle" x="105.05" y="-362.7" font-family="Arial" font-size="11.00">Classification</text>
</g>
<!-- Start&#45;&gt;Classify -->
<g id="edge1" class="edge">
<title>Start-&gt;Classify</title>
<path fill="none" stroke="black" d="M105.05,-443.73C105.05,-436.06 105.05,-426.65 105.05,-417.24"></path>
<polygon fill="black" stroke="black" points="108.55,-417.11 105.05,-407.11 101.55,-417.11 108.55,-417.11"></polygon>
</g>
<!-- ToClass -->
<g id="node3" class="node">
<title>ToClass</title>
<path fill="none" stroke="black" d="M84.14,-291.4C84.14,-291.4 11.95,-291.4 11.95,-291.4 5.95,-291.4 -0.05,-285.4 -0.05,-279.4 -0.05,-279.4 -0.05,-267.4 -0.05,-267.4 -0.05,-261.4 5.95,-255.4 11.95,-255.4 11.95,-255.4 84.14,-255.4 84.14,-255.4 90.14,-255.4 96.14,-261.4 96.14,-267.4 96.14,-267.4 96.14,-279.4 96.14,-279.4 96.14,-285.4 90.14,-291.4 84.14,-291.4"></path>
<text text-anchor="middle" x="48.05" y="-276.7" font-family="Arial" font-size="11.00">Few Queries:</text>
<text text-anchor="middle" x="48.05" y="-263.5" font-family="Arial" font-size="11.00">Defined Classes</text>
</g>
<!-- Classify&#45;&gt;ToClass -->
<g id="edge2" class="edge">
<title>Classify-&gt;ToClass</title>
<path fill="none" stroke="black" d="M89.32,-344.78C81.23,-330.99 71.42,-314.26 63.39,-300.56"></path>
<polygon fill="black" stroke="black" points="66.24,-298.5 58.16,-291.64 60.2,-302.04 66.24,-298.5"></polygon>
<text text-anchor="middle" x="83.55" y="-312.1" font-family="Arial" font-size="9.00">Few</text>
</g>
<!-- ToOther -->
<g id="node4" class="node">
<title>ToOther</title>
<path fill="#ffe6e6" stroke="#ff6666" stroke-width="2" d="M197.95,-291.4C197.95,-291.4 126.15,-291.4 126.15,-291.4 120.15,-291.4 114.15,-285.4 114.15,-279.4 114.15,-279.4 114.15,-267.4 114.15,-267.4 114.15,-261.4 120.15,-255.4 126.15,-255.4 126.15,-255.4 197.95,-255.4 197.95,-255.4 203.95,-255.4 209.95,-261.4 209.95,-267.4 209.95,-267.4 209.95,-279.4 209.95,-279.4 209.95,-285.4 203.95,-291.4 197.95,-291.4"></path>
<text text-anchor="middle" x="162.05" y="-276.7" font-family="Arial" font-size="11.00">Most Queries:</text>
<text text-anchor="middle" x="162.05" y="-263.5" font-family="Arial" font-size="11.00">'Other' Category</text>
</g>
<!-- Classify&#45;&gt;ToOther -->
<g id="edge3" class="edge">
<title>Classify-&gt;ToOther</title>
<path fill="none" stroke="black" stroke-width="2" d="M120.77,-344.78C128.86,-330.99 138.67,-314.26 146.7,-300.56"></path>
<polygon fill="black" stroke="black" stroke-width="2" points="149.9,-302.04 151.93,-291.64 143.86,-298.5 149.9,-302.04"></polygon>
<text text-anchor="middle" x="149.8" y="-312.1" font-family="Arial" font-size="9.00">Most</text>
</g>
<!-- Problem -->
<g id="node5" class="node">
<title>Problem</title>
<polygon fill="#ffcccc" stroke="#ff0000" stroke-width="3" points="166.9,-218.2 41.19,-218.2 41.19,-171 166.9,-171 166.9,-218.2"></polygon>
<text text-anchor="middle" x="104.05" y="-204.5" font-family="Arial" font-size="11.00">‚ö†Ô∏è PROBLEM:</text>
<text text-anchor="middle" x="104.05" y="-191.3" font-family="Arial" font-size="11.00">Most queries in 'Other'</text>
<text text-anchor="middle" x="104.05" y="-178.1" font-family="Arial" font-size="11.00">Defeats Purpose!</text>
</g>
<!-- ToClass&#45;&gt;Problem -->
<g id="edge4" class="edge">
<title>ToClass-&gt;Problem</title>
<path fill="none" stroke="black" d="M60.48,-255.36C66.61,-246.95 74.2,-236.54 81.32,-226.77"></path>
<polygon fill="black" stroke="black" points="84.34,-228.57 87.4,-218.42 78.68,-224.44 84.34,-228.57"></polygon>
</g>
<!-- ToOther&#45;&gt;Problem -->
<g id="edge5" class="edge">
<title>ToOther-&gt;Problem</title>
<path fill="none" stroke="black" stroke-width="2" d="M149.17,-255.36C142.76,-246.86 134.8,-236.33 127.37,-226.48"></path>
<polygon fill="black" stroke="black" stroke-width="2" points="130.1,-224.3 121.28,-218.42 124.52,-228.51 130.1,-224.3"></polygon>
</g>
<!-- ConsiderBERT -->
<g id="node6" class="node">
<title>ConsiderBERT</title>
<path fill="none" stroke="black" d="M129.04,-133.8C129.04,-133.8 79.06,-133.8 79.06,-133.8 73.06,-133.8 67.06,-127.8 67.06,-121.8 67.06,-121.8 67.06,-109.8 67.06,-109.8 67.06,-103.8 73.06,-97.8 79.06,-97.8 79.06,-97.8 129.04,-97.8 129.04,-97.8 135.04,-97.8 141.04,-103.8 141.04,-109.8 141.04,-109.8 141.04,-121.8 141.04,-121.8 141.04,-127.8 135.04,-133.8 129.04,-133.8"></path>
<text text-anchor="middle" x="104.05" y="-119.1" font-family="Arial" font-size="11.00">Try BERT</text>
<text text-anchor="middle" x="104.05" y="-105.9" font-family="Arial" font-size="11.00">Finetuning?</text>
</g>
<!-- Problem&#45;&gt;ConsiderBERT -->
<g id="edge6" class="edge">
<title>Problem-&gt;ConsiderBERT</title>
<path fill="none" stroke="black" d="M104.05,-170.97C104.05,-162.54 104.05,-152.88 104.05,-144.08"></path>
<polygon fill="black" stroke="black" points="107.55,-143.9 104.05,-133.9 100.55,-143.9 107.55,-143.9"></polygon>
</g>
<!-- Problem2 -->
<g id="node7" class="node">
<title>Problem2</title>
<polygon fill="#ffcccc" stroke="#ff0000" stroke-width="3" points="171.89,-60.7 36.21,-60.7 36.21,-0.1 171.89,-0.1 171.89,-60.7"></polygon>
<text text-anchor="middle" x="104.05" y="-46.9" font-family="Arial" font-size="11.00">‚ö†Ô∏è PROBLEM:</text>
<text text-anchor="middle" x="104.05" y="-33.7" font-family="Arial" font-size="11.00">Must retrain for</text>
<text text-anchor="middle" x="104.05" y="-20.5" font-family="Arial" font-size="11.00">each new class</text>
<text text-anchor="middle" x="104.05" y="-7.3" font-family="Arial" font-size="11.00">Maintenance Nightmare!</text>
</g>
<!-- ConsiderBERT&#45;&gt;Problem2 -->
<g id="edge7" class="edge">
<title>ConsiderBERT-&gt;Problem2</title>
<path fill="none" stroke="black" d="M104.05,-97.52C104.05,-89.74 104.05,-80.21 104.05,-70.84"></path>
<polygon fill="black" stroke="black" points="107.55,-70.81 104.05,-60.81 100.55,-70.81 107.55,-70.81"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
</section>
<section id="lesson-4-off-the-shelf-evals-dont-work-that-well" class="level1">
<h1>Lesson 4: Off-the-shelf evals don‚Äôt work that well</h1>
<p>Off-the shelf evals don‚Äôt work that well. In the different frameworks/vendors interfaces for LLM applications evaluation, you‚Äôll stumble upon two kinds of metrics:</p>
<ul>
<li><p><strong>LLM-based metrics:</strong> These metrics use an LLM to evaluate the quality of the output based on some criteria (e.g., relevance, coherence, etc.). While these metrics can be useful, the prompt used in them is generic and not at all tailored to your specific application and its requirements. Think of LLM-as-a-judge for a second. Usually, you would want the judge to have ample context about your application and the specific criterion you want to evaluate. A generic prompt won‚Äôt cut it at all. The same goes for the metrics that are LLM-based.</p></li>
<li><p><strong>Non-LLM-based metrics:</strong> These metrics are usually quite generic (e.g., BLEU, ROUGE, etc.) and don‚Äôt capture how well your application is performing on a business standpoint.</p></li>
</ul>
<p>In this <a href="https://docs.ragas.io/en/latest/concepts/metrics/available_metrics/#agents-or-tool-use-cases">page</a>, you can find many examples of both families of metrics.</p>
<p>Thse non-custom metrics will tell you if your system is so bad but can‚Äôt be used that much for <strong>incremental improvements</strong>. Many times, I‚Äôve seen that incremental improvements have as much impact on the LLM-based metrics as just rerunning your code with the same prompt and the same settings.</p>
<p>Now, all the vendors I‚Äôve worked with allow you to create custom metrics (usually called <code>scorer</code>). So, you can use some vendor API to create your own custom metric in code and have it integrated in their evaluation interface.</p>
</section>
<section id="lesson-5-the-evaluation-interface-matters" class="level1">
<h1>Lesson 5: The evaluation interface matters</h1>
<p>When using an interface to evaluate your LLM applications, the interface matters a lot. A good interface should in general empower you to spot the failure modes and annotate your data easily.</p>
<p>I‚Äôve worked with many vendors providing LLM evaluation interfaces for LLM applications. Their interfaces are quite similar and are actually pretty good to hit the ground running. They will allow you to go through the traces of your LLM applications, see the inputs and outputs, and annotate them with a few clicks. However, what I usually find lacking is the following:</p>
<ul>
<li><p>One pattern that slows me most is not having a specific field for failure mode annotation. The slowing down appears most when for example some failure modes have already appeared in the data but I‚Äôll have to write them down again and again for each new trace that I see. Having a specific field for failure mode annotation or just the most recurrent failure modes as options to select from would speed up the annotation process a lot.</p></li>
<li><p>Formatting üíÑ is not customizable: Imagine you have an app for writing emails. When doing your error analysis, you want to see the email formatted as it would appear in an email client (with subject, greeting, body, signature, etc.). This will allow you to easily spot the failure modes instead of having to look at a JSON or a plain blob of text (which is the case of all the interfaces I know). The absence of appropriate formatting slows down the error analysis process a lot.</p></li>
</ul>
<p>If you want to know more about this topic, I recommend you read <a href="https://chrislovejoy.me/llm-native-expert-system">this talk</a> I wrote by Christopher Lovejoy on building LLM-native apps in vertical industries.</p>
</section>
<section id="final-notes" class="level1">
<h1>Final notes</h1>
<ul>
<li><p>Don‚Äôt hesitate to reach out to me on <a href="https://www.linkedin.com/in/chsafouane/">LinkedIn</a> or via email (chsafouane@gmail.com) if you‚Äôd like to talk about this topic or if you have any questions. My company <a href="https://www.linkedin.com/company/lumiereai/">Lumiereai</a> also offers consulting services on this topic.</p></li>
<li><p>This blog post is not exhaustive. Just before publishing it, I‚Äôve noticed that Hamel Husain has published a very extensive <a href="https://hamel.dev/blog/posts/evals-faq/">blog post</a> on the same topic with many more lessons learnt. I highly recommend you read it as well. He‚Äôs the most knowledgeable person I know on this topic and I‚Äôve learnt a lot from his work.</p></li>
<li><p>I wasn‚Äôt paid at all to say this and this is a really a personal advice: If you have the money or your company can pay for it, I really advise you to take Hamel &amp; Shreya‚Äôs <a href="https://maven.com/parlance-labs/evals">course</a> on LLM evals. It‚Äôs worth every penny and will save you a lot of time and effort in the long run. Otherwise, there is an upcoming book on the same topic that they are writing with Oreilly. Keep an eye on it.</p></li>
</ul>


</section>

 ]]></description>
  <category>LLM</category>
  <category>Agent</category>
  <category>Evaluation</category>
  <guid>https://chsafouane.github.io/posts/LLM evaluation/LLM evaluation.html</guid>
  <pubDate>Tue, 18 Nov 2025 23:00:00 GMT</pubDate>
</item>
<item>
  <title>PDF parsing is hard</title>
  <dc:creator>Safouane Chergui</dc:creator>
  <link>https://chsafouane.github.io/posts/PDF parsing is hard/PDF parsing is hard.html</link>
  <description><![CDATA[ 





<p>The goal of this blogpost is to explain what a PDF is internally and why parsing PDF files is not that easy.</p>
<p>Lately, I‚Äôve been working on a project with a customer where the goal is to extract some specific information from PDF documents. To my big surprise, this task has proven to be quite challenging.</p>
<p>The main challenges stem from the following elements:</p>
<ul>
<li><strong>Privacy concerns:</strong> using an external API to parse the PDFs was a no-go as the PDFs contained sensitive information.</li>
<li><strong>Complexity of the documents:</strong> the PDFs at hand contained a mix of text, complex tables, math formulas, all of which needed to be processed and understood in context.</li>
<li><strong>Absence of a clear structure:</strong> the lack of consistent formatting and structure across the documents made it difficult to apply standard parsing across the board.</li>
</ul>
<br><br>
<div data-align="center">
<p><img src="https://chsafouane.github.io/posts/PDF parsing is hard/assets/pdf-icon.png" alt="PDF icon" width="25%" style="display: block; margin: 0 auto;"></p>
</div>
<p><br></p>
<section id="what-the-hell-is-a-pdf-document" class="level2">
<h2 class="anchored" data-anchor-id="what-the-hell-is-a-pdf-document">What the hell is a PDF document ?</h2>
<section id="a-first-glimpse-at-a-pdf-file-internal-structure" class="level3">
<h3 class="anchored" data-anchor-id="a-first-glimpse-at-a-pdf-file-internal-structure">A first glimpse at a PDF file internal structure</h3>
<p>Have you ever opened a PDF document with notepad or vscode instead of your preferred PDF reader ? If you do so , you‚Äôll stumble upon something that looks like this :</p>
<div data-align="center">
<p><img src="https://chsafouane.github.io/posts/PDF parsing is hard/assets/example_pdf_start.png" alt="PDF Internal Structure" style="display: block; margin: 0 auto;"></p>
<p align="center">
<em>Figure 1: Internal structure of a PDF document when viewed as raw text</em>
</p>
</div>
<p>If you‚Äôd like to see the full PDF internal structure, you can find the example PDF <a href="https://gist.github.com/chsafouane/0079eb20531a0effb632e9aea7ddfabe?short_path=b320036">here</a>.</p>
</section>
<section id="pdf-page-description-language" class="level3">
<h3 class="anchored" data-anchor-id="pdf-page-description-language">PDF Page Description Language</h3>
<p>To understand why PDFs are hard to parse, one must understand how a PDF file is built.</p>
<p>A PDF file is based on Page Description Language (PDL), which is a language used to describe the layout and appearance of a printed page. PDF PDL provides a standardized set of commands to reconstruct a page with perfect fidelity.</p>
<p>As a result, a PDF file is essentially a collection of instructions for rendering a page, rather than a linear sequence of text and images. If you look at the example pdf available in the github gist, you‚Äôll see starting line 34 the following commands:</p>
<pre class="pdf"><code>/F1 18 Tf
100 700 Td
(This is a PDF tutorial) Tj</code></pre>
<p>What the following instructions do is:</p>
<ul>
<li><code>/F1 18 Tf</code> : set the font to F1 with size 18</li>
<li><code>100 700 Td</code> : move the text position to (100, 700)</li>
<li><code>(This is a PDF tutorial) Tj</code> : show the text string</li>
</ul>
<p>Every PDF looks just like this; a precise sequence of commands that specify what to draw and exactly at what coordinates. It does not contain a semantic representation of its content. It does not state, ‚ÄúThis is a paragraph that flows through two columns‚Äù or ‚Äúthis is a table‚Äù.</p>
<p>A table, for example, is just a grid of lines and text positioned at specific coordinates. There are no inherent relationships between the cells, no indication of headers or footers, and no understanding of the data contained within.</p>
<p>So when a parser sees what‚Äôs supposed to be a table, it sees just a bunch of lines and text. Its task (rather difficult task) is to infer the structure and relationships between these elements.</p>
<p>This lack of semantic structure makes it challenging to parse complex PDF documents.</p>
</section>
<section id="the-internal-structure-of-a-pdf" class="level3">
<h3 class="anchored" data-anchor-id="the-internal-structure-of-a-pdf">The internal structure of a PDF</h3>
<p>This is an optional part and will not help you in understanding the difficulty of parsing PDFs. So you can skip if you want to focus on the practical aspects of PDF parsing.</p>
<p>What you see in Figure 1 or in the gist file is the internal structure of a PDF document. Let us dive into the key components that make up this structure.</p>
<p>A PDF is composed internally of four sections:</p>
<div data-align="center">
<p><img src="https://chsafouane.github.io/posts/PDF parsing is hard/assets/pdf_internal_structure.png" alt="PDF Internal Structure Components" style="display: block; margin: 0 auto;"></p>
<p align="center">
<em>Figure 2: Internal structure of a PDF document</em>
</p>
<p align="center">
<small>Source: <a href="https://www.researchgate.net/figure/An-example-of-the-PDF-file-structure_fig1_360275035">ResearchGate - An example of the PDF file structure</a></small>
</p>
</div>
<section id="the-header" class="level4">
<h4 class="anchored" data-anchor-id="the-header">The header</h4>
<p>The header of a PDF file tells you about the PDF specifications version used to generate it. It is always the first line of the file and starts with the <code>%PDF-</code> marker. In Figure 1, it corresponds to <code>%PDF-1.7</code>.</p>
</section>
<section id="the-body" class="level4">
<h4 class="anchored" data-anchor-id="the-body">The body</h4>
<p>Now, the body is where you define the content of the PDF. Everything that you see when you open a PDF - the text you read, the images you view, the fonts that make the text look pretty - all of this is generated from the ‚Äúobjects‚Äù defined in the body.</p>
<p>Think about when you open a PDF and scroll through it. You might see different pages, each with its own layout, fonts, and content. Behind the scenes, each of these elements is stored as a separate object in the PDF body.</p>
<p>If you look at the PDF file in the gist, you‚Äôll see that it contains 5 objects. Each object in a PDF is identified by a unique object number and a generation number (usually 0 for new objects).</p>
</section>
<section id="the-cross-reference-table" class="level4">
<h4 class="anchored" data-anchor-id="the-cross-reference-table">The cross-reference table</h4>
<p>Now, here‚Äôs where the magic happens that makes PDFs so fast to navigate. You know how you can instantly jump to page 50 of a 200-page PDF, or how quickly a PDF opens even when it‚Äôs a large file? That‚Äôs thanks to the cross-reference table (or ‚Äúxref table‚Äù).</p>
<p>The xref table maps object numbers to their byte positions in the file. Here‚Äôs the one from our sample PDF:</p>
<pre class="pdf"><code>xref
0 6
0000000000 65535 f 
0000000017 00000 n 
0000000070 00000 n 
0000000126 00000 n 
0000000281 00000 n 
0000000385 00000 n </code></pre>
<p>Let me break this down:</p>
<ul>
<li><code>xref</code> marks the start of the cross-reference table</li>
<li><code>0 6</code> means this section covers 6 objects starting from object 0</li>
<li>Each line has three parts: <code>byte_offset generation_number n/f</code>
<ul>
<li><strong>Byte offset</strong>: The exact position in the file where the object starts (like a street address)</li>
<li><strong>Generation number</strong>: Usually 0 for active objects</li>
<li><strong>n/f flag</strong>: <code>n</code> means the object is in use, <code>f</code> means it‚Äôs free (deleted)</li>
</ul></li>
</ul>
<p>The generation number and the n/f flag are useful when the PDF is modified.</p>
<p>For example, when you want to see the page content, the PDF reader looks up object 4 (content stream) in this table, sees it at byte position 281, jumps directly there, and gets the drawing commands. No searching, no scanning, just instant access.</p>
<p>This is why PDFs load so quickly even when they‚Äôre huge files. Your PDF viewer doesn‚Äôt have to read the whole document.</p>
</section>
<section id="the-trailer" class="level4">
<h4 class="anchored" data-anchor-id="the-trailer">The trailer</h4>
<p>Finally, we have the trailer - think of it as the PDF‚Äôs ‚Äúinstruction manual‚Äù that tells your PDF viewer how to get started. When you double-click a PDF file to open it, your PDF reader doesn‚Äôt start reading from the beginning. Instead, it jumps to the end of the file and reads the trailer first.</p>
<p>Here‚Äôs the trailer from our sample PDF:</p>
<pre class="pdf"><code>trailer
&lt;&lt; /Size 6
/Root 1 0 R
&gt;&gt;
startxref
449
%%EOF</code></pre>
<p>Here‚Äôs what happens when you open a PDF:</p>
<ul>
<li><strong><code>/Size 6</code></strong>: The PDF reader learns there are 6 objects total in the cross-reference table</li>
<li><strong><code>/Root 1 0 R</code></strong>: ‚ÄúStart reading from the catalog object (object 1) to understand the document structure‚Äù</li>
<li><strong><code>startxref 449</code></strong>: ‚ÄúThe cross-reference table starts at byte position 449‚Äù</li>
<li><strong><code>%%EOF</code></strong>: ‚ÄúThis is truly the end of the file‚Äù</li>
</ul>
<p>So when you open a PDF, here‚Äôs the process: 1. Your PDF reader jumps to the end and reads the trailer 2. From the trailer, it gets to know that the xref table is at position 449 and reads it to understand where all objects are 3. When you scroll or jump to a page, it uses the xref table to instantly find the right objects</p>
<p>This four-part structure (header, body, xref, trailer) is what makes PDFs very fast to read no matter their size.</p>
</section>
</section>
</section>
<section id="docling-v2" class="level2">
<h2 class="anchored" data-anchor-id="docling-v2">Docling V2</h2>
<div data-align="center">
<p><img src="https://chsafouane.github.io/posts/PDF parsing is hard/assets/docling_logo.png" alt="Docling Logo" width="50%" style="display: block; margin: 0 auto;"></p>
</div>
<section id="project-context" class="level3">
<h3 class="anchored" data-anchor-id="project-context">Project context</h3>
<p>So, here are the main constraints of the project: - It had some high privacy concerns. This means that using an external API for PDF parsing was not an option. - The PDFs were very complex. They contained a mix of text and really complex tables, math formulas, etc. - The customer preferred to run the workload of PDF parsing on their on-premise infrastructure that didn‚Äôt provide any GPU.</p>
<p>The point that was to our advantage is that the incoming documents didn‚Äôt need to be processed online. Batch processing of documents was sufficient, and I could afford to take our time with the parsing.</p>
</section>
<section id="why-i-went-for-docling" class="level3">
<h3 class="anchored" data-anchor-id="why-i-went-for-docling">Why I went for Docling ?</h3>
<section id="the-fast-good-enough-didnt-cut-it" class="level4">
<h4 class="anchored" data-anchor-id="the-fast-good-enough-didnt-cut-it">The fast &amp; good enough didn‚Äôt cut it!</h4>
<p>While I used to go with <code>PyMuPDF</code> for PDF parsing because it‚Äôs easy to use, fast, and good enough for PDF with text and simple tables, it did a really bad job on the documents that I had to handle. The tables were very badly parsed.</p>
<p>To preserve the speed advantage, I decided to use a combination of <code>PyMuPDF</code> for the initial text extraction and a library dedicated to table extraction like <code>tabula</code> or <code>camelot</code>. Not only did this approach add more dependencies and more complexity, <code>tabula</code> and <code>camelot</code> both did a very bad job at extracting most tables.</p>
<p>Now, these packages look at the PDF instructions (like the ones shown in the PDL section) and try to reverse-engineer the layout of the document. While this makes for fast parsing, they have a hard time parsing a two-column layout accurately or a complex table. A good way to put it is that they have a hard time looking at things a human does.</p>
<p><code>camelot</code> and <code>tabula</code> both rely on heuristics and rules that work well for simple well-structured tables.</p>
</section>
<section id="ml-focused-parsing" class="level4">
<h4 class="anchored" data-anchor-id="ml-focused-parsing">ML-focused parsing</h4>
<p>ML-focused parsing usually make use of: - a parsing engine to parse text - Some layout detection model to detect the different object in the page (e.g.&nbsp;headers, text blocks, images, tables, etc.) - Some table analysis model - Some post-processing steps to combine all the results together</p>
<p>I benchmarked <code>unstructured</code> and <code>docling</code> and found that <code>docling</code> was doing a better job at parsing the documents I had to handle.</p>
<p><strong>Note:</strong> I didn‚Äôt test unstructured API which seems to offer more functionalities than the open-source package.</p>
</section>
</section>
<section id="how-does-docling-work" class="level3">
<h3 class="anchored" data-anchor-id="how-does-docling-work">How does Docling work ?</h3>
<p>Docling uses a combination of techniques to parse PDF documents effectively:</p>
<ol type="1">
<li><p><strong>Text Extraction</strong>: Initially, it extracts text from the PDF using a fast and efficient text extraction engine.</p></li>
<li><p><strong>Layout Detection</strong>: It employs a layout detection model to identify different elements on the page, such as titles, text, images, tables, etc.</p></li>
<li><p><strong>Table Analysis</strong>: For detected tables, Docling uses a specialized table analysis model to understand the structure and content of the table cells.</p></li>
<li><p><strong>OCR</strong>: Optionally, one can activate OCR if handling scanned documents.</p></li>
<li><p><strong>Assembly</strong>: Finally, it applies post-processing steps to combine all the extracted information and present it in a structured format in <code>DoclingDocument</code>.</p></li>
</ol>
<p>The resulting object <code>DoclingDocument</code> is not a simple text string. It is a hierarchical representation of the original document, containing organized lists of items defined in Docling (<code>TextItem</code>, <code>PictureItem</code>, etc.). Each of these objects holds its content, coordinates, type, and relationships to other elements.</p>
<p>Please refer to the <a href="https://docling-project.github.io/docling/concepts/docling_document/">Docling documentation</a> for more details on the structure and usage of <code>DoclingDocument</code>.</p>
</section>
<section id="parsing-output" class="level3">
<h3 class="anchored" data-anchor-id="parsing-output">Parsing output</h3>
<p>On top of the docling document that contains anything you can imagine, you can convert the docling document to a a simple string or to a markdown. You can also extract tables as pandas dataframes wich is really very handy.</p>
</section>
<section id="docling-in-practice" class="level3">
<h3 class="anchored" data-anchor-id="docling-in-practice">Docling in practice</h3>
<p>I used docling on french documents. A document made of more or less 60 pages, between 5 or 10 tables takes between 60 and 90 seconds using Docling.</p>
<p>The things that didn‚Äôt work that well include: - tables that roll over two pages. In my experience, Docling considers them as separate tables - multicolumn text is rarely but sometimes is considered a table</p>
</section>
<section id="explore-more-with-docling" class="level3">
<h3 class="anchored" data-anchor-id="explore-more-with-docling">Explore more with Docling!</h3>
<ul>
<li>Docling can be used to parse many types of documents like powerpoint docs, word docs, html docs, PDFs and more.</li>
</ul>
<div data-align="center">
<p><img src="https://chsafouane.github.io/posts/PDF parsing is hard/assets/docling_processing.png" alt="Docling Processing" width="60%" style="display: block; margin: 0 auto;"></p>
</div>
<p><br><br> - Docling is also designed to be used seamlessly with RAG and supports functionalities like chunking documents. - More recent packages in the docling family of packages are:</p>
<ul>
<li><a href="https://github.com/docling-project/docling-serve"><code>docling-serve</code></a>: The FastAPI wrappers for running Docling as REST API and distribute large jobs.</li>
<li><a href="https://github.com/docling-project/docling-sdg"><code>docling-sdg</code></a>: Synthetic data generation (SDG) on documents for dataset generation for RAG, finetuning, etc.</li>
<li><a href="https://github.com/docling-project/docling-mcp"><code>docling-mcp</code></a>: The definition of tools with the Model Context Protocol for document conversion, manipulation and generation agents.</li>
</ul>
<p>While I didn‚Äôt try these three packages, I‚Äôm looking forward to it.</p>
</section>
<section id="some-final-feedback" class="level3">
<h3 class="anchored" data-anchor-id="some-final-feedback">Some final feedback</h3>
<p>While <code>docling</code> is an amazing framework, it still has some limitations and areas for improvement. - If you‚Äôre just looking for speed and good enough result, go for PyMuPDF - If you‚Äôre looking for excellent parsing quality and are ready to trade speed for it, go for Docling</p>
<p><br><br> <strong>Happy parsing with DOCLING&nbsp;!</strong></p>


</section>
</section>

 ]]></description>
  <category>Python</category>
  <category>PDF</category>
  <guid>https://chsafouane.github.io/posts/PDF parsing is hard/PDF parsing is hard.html</guid>
  <pubDate>Thu, 28 Aug 2025 22:00:00 GMT</pubDate>
</item>
<item>
  <title>Why I ditched pip and conda for Pixi</title>
  <dc:creator>Safouane Chergui</dc:creator>
  <link>https://chsafouane.github.io/posts/Pixi intro/Why I ditched conda and pip for Pixi.html</link>
  <description><![CDATA[ 





<p>I‚Äôve been using pip and then conda for as long as I can remember. Last year, I did a double-switch. First, I moved to <code>uv</code> and then not long after it I moved to <code>pixi</code>.</p>
<p>I discovered <code>pixi</code> thanks to Eric Ma <a href="https://ericmjl.github.io/blog/2024/8/16/its-time-to-try-out-pixi/">blog post</a>. At the time, the thing that caught my attention the most is how easy it is to manage the installation of the same environment but one with CUDA support and the other without.</p>
<p>After months of using <code>pixi</code> now, I can say that the 3 things I like the most about <code>pixi</code> are: - The features concept that allows to mix and match packages to create environments - Being able to run tasks - How fast it is!</p>
<p>We‚Äôll take a look at all of this in this blog. The final version of the code generated in this blog is available in <a href="https://github.com/chsafouane/pixi_tut_chsafouane_github_io">this repository</a>.</p>
<section id="what-is-pixi" class="level1">
<h1><a id="toc1_"></a>What is pixi ?</h1>
<p align="center">
<img src="https://chsafouane.github.io/posts/Pixi intro/assets/pixi.webp" width="50%">
</p>
<section id="pixis-toolset" class="level2">
<h2 class="anchored" data-anchor-id="pixis-toolset"><a id="toc1_1_"></a>Pixi‚Äôs toolset</h2>
<p>Now, Pixi is many things but I‚Äôll focus on the things that will be of use to you as a python developer</p>
<ul>
<li>Pixi is a package manager that can manage packages from both Conda &amp; PyPI. The dependency resolution tools used by Pixi (<code>resolvo</code> for conda &amp; uv resolution tool for PyPI packages) are very fast.</li>
<li>Pixi manages environments (similar to <code>venv</code> for <code>pip</code> users, a feature that is built into <code>conda</code>)</li>
<li>Pixi manages <code>python</code> version as well (similar to <code>pyenv</code> if you use <code>pip</code>, built into <code>conda</code>)</li>
<li>Pixi has a lock file that allows you to reproduce excatly the same environment (similar to what you‚Äôd get <code>conda-lock</code> or <code>pip-lock</code>)</li>
<li>Pixi can be used as a task-runner, just like <code>make</code> or <code>just</code>.</li>
<li>Pixi has built-in cross-platform reproducibility. The lock file includes the exact versions and dependencies in all targeted platforms. You can pick and choose the targeted platform by your project (Linux, Windows, etc).</li>
<li>Pixi can also install tools like <code>brew</code> and you can have access to the globally.</li>
</ul>
<p>Now, while <code>mamba</code> is fast, in my experience, <code>pixi</code> is faster. <code>mamba</code> also lacks lock-files that are essential for reproducibility and a task runner that comes very handy in many situations (CI/CD, Other people running your project, etc.)</p>
</section>
<section id="pixis-project-philosophy" class="level2">
<h2 class="anchored" data-anchor-id="pixis-project-philosophy"><a id="toc1_2_"></a>Pixi‚Äôs project philosophy</h2>
<p>While <code>conda</code> is environment-centric, <code>pixi</code> is all about projects. When you init a pixi project, it will create a <code>pixi.toml</code> (or a <code>pyproject.toml</code> instead if you want). In this file, you can specify many environments that can be composed of different features. For example, you can have: - a base feature that includes the basic packages needed by your project - a run feature that consists of packages needed for only running the project - a test feature that consists of additional packages needed for testing the project - a build feature that consists of additional packages or tools needed for building the project.</p>
<p>Imagine having to train a model on a GPU but then when running it, to only have a CPU at your disposal. What you would do is have: - A training environment composed of the features <code>base</code> + <code>build</code> + <code>test</code> that will include the base packages, some CUDA dependencies and pytorch with GPU support coming from the build feature, and test packages like <code>pytest</code> coming from the test feature. - A CI/CD environment composed of <code>base</code> + <code>run</code> + <code>test</code>. The only difference this time is that you‚Äôll be using the run feature that include <code>pytorch-cpu</code> and no CUDA dependencies. - A run environment composed only of <code>base</code> + <code>run</code> features.</p>
<p>The other nice thing is that you can say that you can enforce that some environments (or all of them) use the same versions of the common packages.</p>
</section>
</section>
<section id="your-first-project-with-pixi" class="level1">
<h1><a id="toc2_"></a>Your first project with <code>pixi</code></h1>
<section id="installation" class="level2">
<h2 class="anchored" data-anchor-id="installation"><a id="toc2_1_"></a>Installation</h2>
<p>Start first by installing <code>pixi</code> by grabbing the one command-line that corresponds to your case from here: <a href="https://pixi.sh/latest/installation">Pixi installation</a>.</p>
<p>It‚Äôs really just one command, restart your terminal and there you go.</p>
</section>
<section id="getting-hands-on" class="level2">
<h2 class="anchored" data-anchor-id="getting-hands-on"><a id="toc2_2_"></a>Getting hands-on</h2>
<section id="initiating-the-project" class="level3">
<h3 class="anchored" data-anchor-id="initiating-the-project"><a id="toc2_2_1_"></a>Initiating the project</h3>
<p>We‚Äôll work through an example where we‚Äôd like to develop a FastAPI app.</p>
<p>Let us initiate a pixi project:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> init fastapi_app <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--format</span> pyproject</span>
<span id="cb1-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> fastapi_app</span></code></pre></div>
<p>If you already have an existing folder, you can simply go inside of it and execute</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> init <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--format</span> pyproject</span></code></pre></div>
<p>By default, pixi uses a <code>pixi.toml</code> file for its configuration. As people in python use <code>pyproject.toml</code>, you can specify that you want to use the latter with the <code>--format pyproject</code>.</p>
<p>The initiation of the project creates the following files:</p>
<p align="center">
<img src="https://chsafouane.github.io/posts/Pixi intro/assets/pixi_init_structure.png" alt="pixi init structure">
</p>
<p>If you look at the content of the <code>pyproject.toml</code>, you‚Äôll see different sections:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[project]</span></span>
<span id="cb3-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">authors</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[{</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">name</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Safouane Chergui"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">email</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chsafouane@gmail.com"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}]</span></span>
<span id="cb3-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">name</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fastapi_app"</span></span>
<span id="cb3-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">requires-python</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;= 3.11"</span></span>
<span id="cb3-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">version</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0.1.0"</span></span>
<span id="cb3-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">dependencies</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fastapi&gt;=0.115.14,&lt;0.116"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"uvicorn[standard]&gt;=0.35.0,&lt;0.36"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb3-7"></span>
<span id="cb3-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[build-system]</span></span>
<span id="cb3-9"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">build-backend</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hatchling.build"</span></span>
<span id="cb3-10"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">requires</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hatchling"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.workspace]</span></span>
<span id="cb3-13"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">channels</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"conda-forge"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb3-14"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">platforms</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"win-64"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb3-15"></span>
<span id="cb3-16"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.pypi-dependencies]</span></span>
<span id="cb3-17"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">fastapi_app</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{ </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">path</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"."</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">editable</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> }</span></span>
<span id="cb3-18"></span>
<span id="cb3-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.tasks]</span></span></code></pre></div>
<p>Let us dive into the most important fields:</p>
<p><strong>The <code>[project]</code> section</strong> includes project metadata. - As we haven‚Äôt added a specific python interpreter to the project, the <code>requires-python</code> entry shows the currently active python interpreter in the terminal. You can change it manually if you want.</p>
<p><strong>The <code>[tool.pixi.workspace]</code> section</strong> has two entries: - The <code>channels</code> shows the conda channels that can be used to download the conda packages.If you have a company repository (like <code>nexus</code>), it can be used instead or added before conda-forge to be used first. - The <code>platforms</code> corresponds to the platform you‚Äôre using. You can add other platforms here and the <code>pixi.lock</code> will include the packages that need to be installed to reproduce the exact environment in the case of the additional platforms.</p>
<p><strong>The <code>[tool.pixi.pypi-dependencies]</code> section</strong> is used to specify the packages to install from PyPI. By default, the code you‚Äôre developping shows up as an editable package. Your code will be installed in editable mode and you‚Äôll be able to see the changes you make to your code directly reflected in your environment.</p>
<p><strong>The <code>[tool.pixi.tasks]</code> section</strong> is empty for the time-being. You can imagine tasks as a replacement of makefiles. We‚Äôll add some tasks later in the blog post.</p>
</section>
<section id="adding-dependencies" class="level3">
<h3 class="anchored" data-anchor-id="adding-dependencies"><a id="toc2_2_2_"></a>Adding dependencies</h3>
<p>Let us add python 3.12 to the project</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> add python=3.12</span></code></pre></div>
<p>As we‚Äôre going to create a FastAPI app, let us add fastapi and uvicorn but this time from PyPI.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> add <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--pypi</span> fastapi <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"uvicorn[standard]"</span></span></code></pre></div>
<p>Now that we have proceeded with adding these dependencies, we can see that we have a <code>pixi.lock</code> file that was created.</p>
<p align="center">
<img src="https://chsafouane.github.io/posts/Pixi intro/assets/pixi_first_installation.png" alt="pixi structure after first installation">
</p>
<p>The <code>pyproject.toml</code> file is now updated to include the new dependencies:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[project]</span></span>
<span id="cb6-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">authors</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[{</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">name</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Safouane Chergui"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">email</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chsafouane@gmail.com"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}]</span></span>
<span id="cb6-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">name</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fastapi_app"</span></span>
<span id="cb6-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">requires-python</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;= 3.11"</span></span>
<span id="cb6-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">version</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0.1.0"</span></span>
<span id="cb6-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">dependencies</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fastapi&gt;=0.115.14,&lt;0.116"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"uvicorn[standard]&gt;=0.35.0,&lt;0.36"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb6-7"></span>
<span id="cb6-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[build-system]</span></span>
<span id="cb6-9"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">build-backend</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hatchling.build"</span></span>
<span id="cb6-10"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">requires</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hatchling"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb6-11"></span>
<span id="cb6-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.workspace]</span></span>
<span id="cb6-13"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">channels</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"conda-forge"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb6-14"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">platforms</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"win-64"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb6-15"></span>
<span id="cb6-16"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.pypi-dependencies]</span></span>
<span id="cb6-17"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">fastapi_app</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{ </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">path</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"."</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">editable</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> }</span></span>
<span id="cb6-18"></span>
<span id="cb6-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.tasks]</span></span>
<span id="cb6-20"></span>
<span id="cb6-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.dependencies]</span></span>
<span id="cb6-22"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">python</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3.12.*"</span></span></code></pre></div>
<section id="pinning-strategy" class="level4">
<h4 class="anchored" data-anchor-id="pinning-strategy"><a id="toc2_2_2_1_"></a>Pinning strategy</h4>
<p>The thing that bothered me the most when I started with <code>pixi</code> is that the pinning of the packages. By default, <code>pixi</code> will use a very strict pinning strategy as you can see with fastapi for example: <code>"fastapi&gt;=0.115.14,&lt;0.116"</code>, even if the user didn‚Äôt specify a version when adding fastapi.</p>
<p>If later you‚Äôd like to install a package that is not compatible with the pinned version of fastapi (even though you don‚Äôt care about the specific minor version of fastapi shown in the pyproject.toml, or the upper bound constraint), you‚Äôll get an error, and this was frustrating.</p>
<p><code>pixi</code> developers explain why <a href="https://prefix.dev/blog/the_python_packaging_debate">they chose this strategy</a> and discuss the matter at length in this <a href="https://github.com/prefix-dev/pixi/issues/639">GitHub issue</a>.</p>
<p>Nonetheless, you can override the pinning strategy by using the <a href="https://pixi.sh/v0.49.0/reference/pixi_configuration/#pinning-strategy">pinning-strategy</a> configuration but we‚Äôll look at pixi‚Äôs config file later.</p>
</section>
</section>
<section id="managing-environments-with-features" class="level3">
<h3 class="anchored" data-anchor-id="managing-environments-with-features"><a id="toc2_2_3_"></a>Managing environments with features</h3>
<p>One of pixi‚Äôs amazing features is being able to manage different sets of dependencies for different purposes (like the example for the run, build, test, etc above) using <code>features</code>. A <code>feature</code> (also called a <code>dependency group</code> is just a named set of dependencies).</p>
<p>By default, when adding packages, pixi will automatically add packages to the standard group of dependencies. You can add packages to a specific feature by using the <code>--feature</code> flag.</p>
<p>Let‚Äôs say that our core dependencies that are needed for running the app are <code>fastapi</code> and <code>uvicorn</code>. Let us add two families of dependencies (two features): - A <code>test</code> feature that will include <code>pytest</code> &amp; <code>pytest-cov</code></p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> add <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--feature</span> test pytest pytest-cov</span></code></pre></div>
<ul>
<li>A <code>dev</code> feature that will include packages needed for development like <code>ruff</code></li>
</ul>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> add <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--feature</span> dev ruff</span></code></pre></div>
<p>When you‚Äôll add this second feature, you‚Äôll get a warning saying that the test feature was added but is not used by any environment and that is ok as we‚Äôre going to do it just after.</p>
<p>Now, if you look at the <code>pyproject.toml</code> file, you‚Äôll see that the dependencies are now grouped by features:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb9-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[project]</span></span>
<span id="cb9-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">authors</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[{</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">name</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Safouane Chergui"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">email</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chsafouane@gmail.com"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}]</span></span>
<span id="cb9-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">name</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fastapi_app"</span></span>
<span id="cb9-4"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">requires-python</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;= 3.11"</span></span>
<span id="cb9-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">version</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0.1.0"</span></span>
<span id="cb9-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">dependencies</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fastapi&gt;=0.115.14,&lt;0.116"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"uvicorn[standard]&gt;=0.35.0,&lt;0.36"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb9-7"></span>
<span id="cb9-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[build-system]</span></span>
<span id="cb9-9"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">build-backend</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hatchling.build"</span></span>
<span id="cb9-10"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">requires</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hatchling"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb9-11"></span>
<span id="cb9-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.workspace]</span></span>
<span id="cb9-13"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">channels</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"conda-forge"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb9-14"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">platforms</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"win-64"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb9-15"></span>
<span id="cb9-16"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.pypi-dependencies]</span></span>
<span id="cb9-17"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">fastapi_app</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{ </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">path</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"."</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">editable</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> }</span></span>
<span id="cb9-18"></span>
<span id="cb9-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.tasks]</span></span>
<span id="cb9-20"></span>
<span id="cb9-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.dependencies]</span></span>
<span id="cb9-22"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">python</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3.12.*"</span></span>
<span id="cb9-23"></span>
<span id="cb9-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.feature.test.dependencies]</span></span>
<span id="cb9-25"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">pytest</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"*"</span></span>
<span id="cb9-26"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">pytest-cov</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"*"</span></span>
<span id="cb9-27"></span>
<span id="cb9-28"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.feature.dev.dependencies]</span></span>
<span id="cb9-29"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">ruff</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"*"</span></span></code></pre></div>
<section id="creating-environments-from-dependency-groups-features" class="level4">
<h4 class="anchored" data-anchor-id="creating-environments-from-dependency-groups-features"><a id="toc2_2_3_1_"></a>Creating environments from dependency groups (features)</h4>
<p>In pixi, every environment is a collection of features (can be two features or more). The main project dependencies added without any feature like <code>fastapi</code> and <code>uvicorn</code> are added to an implicit default feature and to a default environment. If you execute</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> project environment list</span></code></pre></div>
<p>You‚Äôll see that the default environment is called <code>default</code> and it includes the default feature.</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Environments:</span></span>
<span id="cb11-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">-</span> default:</span>
<span id="cb11-3">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">features:</span> default</span></code></pre></div>
<p>When you create a feature like <code>test</code>, pixi will create an environment from the default feature + the <code>test</code> feature, unless you explicitly say that you don‚Äôt want to do so. This means, that by default, the <code>test</code> environment isn‚Äôt composed of just the dependencies in the <code>test</code> feature but also the dependencies in the default feature: - All dependencies from the default feature (fastapi, uvicorn) - All dependencies from the <code>test</code> feature (pytest, pytest-cov)</p>
<p>Before creating the environments, let us tackle one last thing: the <code>solve-groups</code>.</p>
<p>Imagine having the default environment that includes <code>fastapi</code> and <code>uvicorn</code> and a <code>test</code> environment that includes additionally <code>pytest</code> and <code>pytest-cov</code>. When pixi will resolve the dependencies, the default environment can have different versions of fastapi and uvicorn than the test environment. To force pixi to group both environments together at the solve stage, you need to say that the test environment should be solved together with the default environment by using the <code>--solve-groups</code> flag.</p>
<p>Here‚Äôs the documentation definition of the <code>--solve-groups</code> flag:</p>
<blockquote class="blockquote">
<p>solve-group: String: The solve group is used to group environments together at the solve stage. This is useful for environments that need to have the same dependencies but might extend them with additional dependencies. For instance when testing a production environment with additional test dependencies.</p>
</blockquote>
<p>Let us create the environments now:</p>
<p><strong>Test environment:</strong></p>
<p>We‚Äôre saying that we want to create a <code>test_env</code> environment that includes the <code>test</code> feature and that we want to solve it together with the default environment (the one that includes fastapi and uvicorn).</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> project environment add fastapi-test-env <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--feature</span> test <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--solve-group</span> default</span></code></pre></div>
<p><strong>Dev environment:</strong></p>
<p>We‚Äôre saying that we want to create a <code>test_env</code> environment that includes the <code>test</code> feature and that we want to solve it together with the default environment (the one that includes fastapi and uvicorn).</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> project environment add fastapi-dev-env <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--feature</span> test <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--feature</span> dev <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--solve-group</span> default</span></code></pre></div>
<p>Now, if you list the environments, you‚Äôll see that the <code>test_env</code> and <code>dev_env</code> are created and that they include the features we specified:</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> project environment list</span>
<span id="cb14-2"></span>
<span id="cb14-3"></span>
<span id="cb14-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Environments:</span></span>
<span id="cb14-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">-</span> default:</span>
<span id="cb14-6">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">features:</span> default</span>
<span id="cb14-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">-</span> fastapi-test-env:</span>
<span id="cb14-8">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">features:</span> test, default</span>
<span id="cb14-9">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">solve_group:</span> default</span>
<span id="cb14-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">-</span> fastapi-dev-env:</span>
<span id="cb14-11">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">features:</span> test, dev, default</span>
<span id="cb14-12">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">solve_group:</span> default</span></code></pre></div>
<p>If you look at the <code>pyproject.toml</code> file, you‚Äôll see that you have a new section called <code>[tool.pixi.environments]</code> that includes the environments you created:</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.environments]</span></span>
<span id="cb15-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">fastapi-test-env</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{ </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">features</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">], </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">solve-group</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"default"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> }</span></span>
<span id="cb15-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">fastapi-dev-env</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{ </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">features</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dev"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">], </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">solve-group</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"default"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> }</span></span></code></pre></div>
<p>All of this can be added manually instead to the pyproject.toml but it‚Äôs error prone and the pixi CLI is honestly very handy.</p>
</section>
<section id="environments-installation" class="level4">
<h4 class="anchored" data-anchor-id="environments-installation"><a id="toc2_2_3_2_"></a>Environments installation</h4>
<p>Now, let us create the environments by first install the default environment</p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> install</span></code></pre></div>
<p>You can also simply run <code>pixi shell</code> to install the default environment and open a shell in it.</p>
<p>To install the dev environment, you can run:</p>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> install fastapi-dev-env</span></code></pre></div>
<p>You can also install all the environments at once using the flag <code>--all</code> to install:</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--all</span></span></code></pre></div>
<p>Now you can any one of the environment inside the shell by running for example:</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> shell fastapi-dev-env</span></code></pre></div>
</section>
</section>
</section>
</section>
<section id="tasks" class="level1">
<h1><a id="toc3_"></a>Tasks</h1>
<p><code>pixi</code> can be used as a task runner and thus would replace <code>make</code> or <code>just</code>. You can define tasks in the <code>pyproject.toml</code> file under the <code>[tool.pixi.tasks]</code> section.</p>
<p>You can use the CLI to add the tasks but sometimes I find it easier to write the tasks manually in <code>pyproject.toml</code> specially if they are multiline tasks.</p>
<p>In the <a href="https://github.com/chsafouane/pixi_tut_chsafouane_github_io">repo</a> provided with this tutorial, you‚Äôll find the files needed (<code>src/main.py</code>) to execute the tasks along with the tutorial.</p>
<section id="creating-tasks" class="level2">
<h2 class="anchored" data-anchor-id="creating-tasks"><a id="toc3_1_"></a>Creating tasks</h2>
<p>To create a task, you can use the <code>pixi task add</code> command and you‚Äôll have to specify two things:</p>
<ul>
<li>The task name</li>
<li>The command to run</li>
</ul>
<p>Execute <code>pixi task add --help</code> to see the available options, as you can add for example environment variables or isolate the task from the shell when running (not having access to the shell variables for example) among other things.</p>
<p>Let us create a task to start a uvicorn server with hot reloading. The task will have as a name <strong>start</strong>. The command will add the task to the <code>pyproject.toml</code> file under the <code>[tool.pixi.tasks]</code> section.</p>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> task add start <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"uvicorn my_app.main:app --reload --host 0.0.0.0"</span></span></code></pre></div>
<p>Let us also add a linting task that uses <code>ruff</code></p>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> task add lint <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ruff check src --fix"</span></span></code></pre></div>
<p>If you look now at the <code>pyproject.toml</code> file, you‚Äôll see that the tasks are added under the <code>[tool.pixi.tasks]</code> section:</p>
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb22-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.tasks]</span></span>
<span id="cb22-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">start</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"uvicorn my_app.main:app --reload --host 0.0.0.0"</span></span>
<span id="cb22-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">lint</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{ </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">task</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ruff check src --fix"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">environment</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fastapi-dev-env"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> }</span></span></code></pre></div>
<section id="running-tasks" class="level3">
<h3 class="anchored" data-anchor-id="running-tasks"><a id="toc3_1_1_"></a>Running tasks</h3>
<p>To run the linting task in the dev environment, you can run:</p>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> run <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-e</span> fastapi-dev-env lint</span></code></pre></div>
<p>You‚Äôll get the following output:</p>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Pixi</span> task <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">lint</span> in fastapi-dev-env<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">:</span> ruff check src <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--fix</span></span>
<span id="cb24-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">All</span> checks passed!</span></code></pre></div>
<p>Now, you can specify in the pyproject.toml the default environment in which the task should run but I haven‚Äôt found a way to do it through the CLI yet.</p>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb25-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.tasks]</span></span>
<span id="cb25-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">start</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"uvicorn my_app.main:app --reload --host 0.0.0.0"</span></span>
<span id="cb25-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">lint</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{ </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">task</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ruff check src --fix"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">environment</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fastapi-dev-env"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> }</span></span></code></pre></div>
<p>As I can‚Äôt go through everything you can do with tasks, I‚Äôll just list the things that I find useful but you can find more in the <a href="https://pixi.sh/latest/workspace/advanced_tasks/">pixi documentation</a>:</p>
<ul>
<li>You can create a task that is composed of many tasks using the <code>dependes-on</code> field. that for example executes the linting task and then runs the app</li>
<li>You can create a tasks that runs the same task in multiple environments. If for example you‚Äôd like to test your code against multiple python versions, you can create a task that runs the same task in environments with different python versions (instead of using matrices of environments in CI/CD). Here an example from pixi‚Äôs documentation:</li>
</ul>
<div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb26-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Task that depends on other tasks in different environments</span></span>
<span id="cb26-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tasks.test-all]</span></span>
<span id="cb26-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">depends-on</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb26-4">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{ </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">task</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">environment</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"py311"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> },</span></span>
<span id="cb26-5">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{ </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">task</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">, </span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">environment</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"py312"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> },</span></span>
<span id="cb26-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div>
<ul>
<li>You can add environment variables or isolate the task when running from the shell (and thus not having access to the shell variables).</li>
<li>If a task depends on another task, you can cache the result of the first task and use it in the second task. Pixi won‚Äôt rerun the first task after doing some verifications that can be found in the <a href="https://pixi.sh/latest/workspace/advanced_tasks/#caching">documentation</a>.</li>
</ul>
</section>
</section>
</section>
<section id="pixis-configuration" class="level1">
<h1><a id="toc4_"></a>Pixi‚Äôs configuration</h1>
<section id="why-another-config-file" class="level2">
<h2 class="anchored" data-anchor-id="why-another-config-file"><a id="toc4_1_"></a>Why another config file ?</h2>
<p>The <code>pyproject.toml</code> (or the <code>pixi.toml</code>) file reprensents the configuration of the pixi project. It includes the project metadata, the dependencies, the environments, the tasks, etc.</p>
<p>There is additional configuration that is not required for the project per say but in a way changes the behavior you would place in a <code>config.toml</code> file.</p>
<p>You can set this config at one of three levels: - locally: in this case, the configuration will be stored <code>your_project/.pixi/config.toml</code> and will impact only the current project. - globally: in this case, the configuration will be stored in <code>$PIXI_HOME/config.toml</code> and will impact all the projects using pixi. - system-wide: in this case, the configuration will be stored in <code>/etc/pixi/config.toml</code> and will impact all the projects using pixi.</p>
<p>You can also use the <code>pixi config set &lt;some_config_key&gt; &lt;some_config_value&gt;</code> command to set the configuration. While I will show you right away the keys that I find useful, you can find the full list of configuration keys as of version 0.49 that you can set:</p>
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb27-1">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span> Supported keys:</span>
<span id="cb27-2">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     default-channels,</span>
<span id="cb27-3">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     authentication-override-file,</span>
<span id="cb27-4">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     tls-no-verify,</span>
<span id="cb27-5">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     mirrors,</span>
<span id="cb27-6">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     detached-environments,</span>
<span id="cb27-7">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     pinning-strategy,</span>
<span id="cb27-8">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     max-concurrent-solves,</span>
<span id="cb27-9">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     repodata-config,</span>
<span id="cb27-10">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     repodata-config.disable-jlap,</span>
<span id="cb27-11">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     repodata-config.disable-bzip2,</span>
<span id="cb27-12">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     repodata-config.disable-zstd,</span>
<span id="cb27-13">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     repodata-config.disable-sharded,</span>
<span id="cb27-14">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     pypi-config,</span>
<span id="cb27-15">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     pypi-config.index-url,</span>
<span id="cb27-16">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     pypi-config.extra-index-urls,</span>
<span id="cb27-17">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     pypi-config.keyring-provider,</span>
<span id="cb27-18">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     shell,</span>
<span id="cb27-19">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     shell.force-activate,</span>
<span id="cb27-20">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     shell.source-completion-scripts,</span>
<span id="cb27-21">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     shell.change-ps1,</span>
<span id="cb27-22">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     s3-options,</span>
<span id="cb27-23">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     s3-options.<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>bucket<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>,</span>
<span id="cb27-24">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     s3-options.<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>bucket<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>.endpoint-url,</span>
<span id="cb27-25">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     s3-options.<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>bucket<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>.region,</span>
<span id="cb27-26">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     s3-options.<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>bucket<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>.force-path-style,</span>
<span id="cb27-27">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     experimental.use-environment-activation-cache,</span>
<span id="cb27-28">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     proxy-config,</span>
<span id="cb27-29">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     proxy-config.https,</span>
<span id="cb27-30">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     proxy-config.http,</span>
<span id="cb27-31">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">‚îÇ</span>     proxy-config.non-proxy-hosts</span></code></pre></div>
</section>
<section id="useful-keys" class="level2">
<h2 class="anchored" data-anchor-id="useful-keys"><a id="toc4_2_"></a>Useful keys</h2>
<section id="using-private-conda-pypi-repositories" class="level3">
<h3 class="anchored" data-anchor-id="using-private-conda-pypi-repositories"><a id="toc4_2_1_"></a>Using private conda &amp; PyPI repositories</h3>
<p>Some of my very security-oriented customers usually have their own conda and pip repositories (like <code>nexus</code>) and oblige everyone to use them as they only include packages that are approved by the security team.</p>
<p>For this, I use <code>pypi-config.index-url</code> and <code>pypi-config.extra-index-urls</code> to specify the index URL and the extra index URLs to use for PyPI packages.</p>
<div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> config set pypi-config.index-url https://nexus.some_random_company.com/pypi/simple</span></code></pre></div>
<p>Looking at the documentation, these can also be added to the <code>pyproject.toml</code> file under the <code>[tool.pixi.pypi-options]</code> section but I‚Äôve never added them here.</p>
<div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb29-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.pypi-options]</span></span>
<span id="cb29-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Public packages will be sourced from the official PyPI</span></span>
<span id="cb29-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">index-url</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://nexus.some_random_company.com/pypi/simple"</span></span>
<span id="cb29-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Internal packages will be searched for here first</span></span>
<span id="cb29-5"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">extra-index-urls</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://nexus.some_additional_random_company.com/pypi/simple"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div>
<p>For conda, I add the channels to the channels entry under the <code>[tool.pixi.workspace]</code> section in the <code>pyproject.toml</code> file:</p>
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode toml code-with-copy"><code class="sourceCode toml"><span id="cb30-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[tool.pixi.workspace]</span></span>
<span id="cb30-2"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">channels</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb30-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://nexus.some_random_company.com/conda-forge"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb30-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://nexus.some_random_company_second.com/conda-forge"</span></span>
<span id="cb30-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb30-6"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">platforms</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"win-64"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div>
<p>If you need to manage credentials for private repositories, you can check <code>pixi auth login</code>.</p>
</section>
<section id="pinning-strategy-1" class="level3">
<h3 class="anchored" data-anchor-id="pinning-strategy-1"><a id="toc4_2_2_"></a>Pinning strategy</h3>
<p>The other key that I find useful is the <code>pinning-strategy</code> key. As I said before, by default, pixi uses a very strict pinning strategy that can be annoying at times. You can change it to one of the strategies listed in the <a href="https://pixi.sh/dev/reference/pixi_configuration/#pinning-strategy">documentation</a>.</p>
<p>Personally, I like to pin to the major version using:</p>
<div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pixi</span> config set pinning-strategy major</span></code></pre></div>
<p>This might not be a very good practice as you can see <a href="https://prefix.dev/blog/the_python_packaging_debate">here</a> but it works just fine for my needs.</p>
</section>
</section>
</section>
<section id="conclusion" class="level1">
<h1><a id="toc5_"></a>Conclusion</h1>
<p>Well, that was quire a ride. I hope you enjoyed it and that you learned something new.</p>
<p>My advice to you is to start using pixi in your personal projects. At first, there is going to be a slight learning curve but once you get used to it, you‚Äôll find it extremely fast and convenient to use.</p>
<p>If you have any questions, feel free to reach out to me on <a href="https://www.linkedin.com/in/safouane-chergui/">my linkedin</a>.</p>


</section>

 ]]></description>
  <category>Python</category>
  <category>Package management</category>
  <guid>https://chsafouane.github.io/posts/Pixi intro/Why I ditched conda and pip for Pixi.html</guid>
  <pubDate>Fri, 04 Jul 2025 22:00:00 GMT</pubDate>
</item>
<item>
  <title>Byte Pair Encoding Tokenization</title>
  <dc:creator>Safouane Chergui</dc:creator>
  <link>https://chsafouane.github.io/posts/Byte Pair Encoding Tokenization/Byte Pair Encoding Tokenization.html</link>
  <description><![CDATA[ 





<p>The aim of this blog is to explain to you how BPE Tokenization works. We‚Äôre going to build a basic tokenizer using BPE tokenization and we‚Äôll apply it on a dummy example.</p>
<p>We‚Äôre not going to go into the gory details of it. If you‚Äôd like a great source for the details of tokenization, watch this 2-hour long <a href="https://www.youtube.com/watch?v=zduSFxRajkE">video by the amazing Andrej Karpathy</a>. Everything in this post comes from Andrej‚Äôs video or the resources he shared in his video.</p>
<p><strong>Table of contents</strong><a id="toc0_"></a><br>
- Hexadecimal representation<br>
- UTF-8 encoding<br>
- Some Unicode vocab<br>
- WTF is UTF-8 ?<br>
- A sentence example<br>
- BPE Tokenization<br>
- BPE in action<br>
- How does it work<br>
- Let us build a BPE tokenizer<br>
- Encoding<br>
- Decoding<br>
- One last problem to solve<br>
- One final example</p>
<!-- vscode-jupyter-toc-config
    numbering=false
    anchor=true
    flat=false
    minLevel=1
    maxLevel=6
    /vscode-jupyter-toc-config -->
<!-- THIS CELL WILL BE REPLACED ON TOC UPDATE. DO NOT WRITE YOUR TEXT IN THIS CELL -->
<section id="hexadecimal-representation" class="level2">
<h2 class="anchored" data-anchor-id="hexadecimal-representation"><a id="toc1_1_"></a>Hexadecimal representation</h2>
<p>Let go for a quick tour of hexadecimal representation. We, as humans, usually represent numbers in base 10. Computers make use of base 2 representation.</p>
<p>Hexadecimal representation means representing a number in base 16. Numbers are represented using 0 to 9 and A-F, with A being equivalent to 10, B to 11, ‚Ä¶, F to 15.</p>
<p>The number 125 can be written in hexadecimal as 7D.</p>
<div id="cell-5" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># d * (16**0) + 7 * (16**1) = 13 + 7 * 16</span></span>
<span id="cb1-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">hex</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">125</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>'0x7d'</code></pre>
</div>
</div>
<p>Now, a byte is represented with 8 bits, with a range going from 00000000 to 11111111 &lt;-&gt; 0 to 255 in decimal &lt;-&gt; 00 to FF in hexadecimal</p>
<div id="cell-7" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">hex</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0xff</code></pre>
</div>
</div>
<p><em>Note:</em> The prefix <code>0x</code> is used in intergers to tell Python to interpret the number as a hexadecimal. For example:</p>
<div id="cell-9" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Python understands that this number is represented in hexadecimal</span></span>
<span id="cb5-2">hex_number <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xff</span></span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(hex_number)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>255</code></pre>
</div>
</div>
</section>
<section id="utf-8-encoding" class="level2">
<h2 class="anchored" data-anchor-id="utf-8-encoding"><a id="toc1_2_"></a>UTF-8 encoding</h2>
<p>Little background about UTF-8 encoding. So, UTF-8 is an encoding that represents Unicode characters using 1 to 4 bytes. So, every string is converted to a series of bytes once encoded using a Unicode encoding (such as UTF-8).</p>
<section id="some-unicode-vocab" class="level3">
<h3 class="anchored" data-anchor-id="some-unicode-vocab"><a id="toc1_2_1_"></a>Some Unicode vocab</h3>
<p>You should know at least these two words when dealing with Unicode: <strong>character</strong> and <strong>code point</strong>: - A character is a textual unit in Unicode. It can be anything ranging from a letter, a digit, an emoji, a mathematical symbol, etc.</p>
<div id="cell-11" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">character <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span></span>
<span id="cb7-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Character: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>character<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># First letter of my name in Arabic</span></span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># You might think of it as S</span></span>
<span id="cb7-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Arabic speakers, don't insult me for this analogy </span></span>
<span id="cb7-7">arabic_s_character <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ÿµ"</span></span>
<span id="cb7-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Arabic character: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>arabic_s_character<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Character: A
Arabic character: ÿµ</code></pre>
</div>
</div>
<ul>
<li>A code point is a unique number assigned to each character in Unicode. You can obtain it in Python using the <code>ord</code> function.</li>
</ul>
<div id="cell-13" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">A_code_point <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">ord</span>(character)</span>
<span id="cb9-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The character </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>character<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> has as a code point </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>A_code_point<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> in decimal, which corresponds to </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">hex</span>(A_code_point)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> in hexadecimal"</span>)</span>
<span id="cb9-3"></span>
<span id="cb9-4">arabic_s_code_point <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">ord</span>(arabic_s_character)</span>
<span id="cb9-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The character </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>arabic_s_character<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> has as a code point </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>arabic_s_code_point<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> in decimal, which corresponds to </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">hex</span>(arabic_s_code_point)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> in hexadecimal"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The character A has as a code point 65 in decimal, which corresponds to 0x41 in hexadecimal
The character ÿµ has as a code point 1589 in decimal, which corresponds to 0x635 in hexadecimal</code></pre>
</div>
</div>
<p><em>Nice to know:</em> - Use <code>ord</code> to go from a character -&gt; a code point - Use <code>chr</code> to go from a code point -&gt; a character</p>
<p>At this step, I highly advise you to take a look at the start of the <a href="https://symbl.cc/en/unicode-table/">Unicode Character Table</a>.</p>
<p>If you look at this table, you‚Äôll see that the character <code>ÿµ</code> doesn‚Äôt have <code>1589</code> as a code point, it rather has <code>U+0635</code>. These are the same number, it‚Äôs just that Unicode uses the hexadecimal notation for code points instead of the decimal one.</p>
</section>
<section id="wtf-is-utf-8" class="level3">
<h3 class="anchored" data-anchor-id="wtf-is-utf-8"><a id="toc1_2_2_"></a>WTF is UTF-8 ?</h3>
<p>So, UTF-8 is a Unicode encoding method. It encodes code points in 1 to 4 bytes (it is a variable-length encoding, not all code points are encoded as 4 bytes as this will consume so much memory!).</p>
<p>Other encoding methods such as UTF-16 and UTF-32 exist but they do things differently than UTF-8. UTF-8 is the most used encoding method in the wild for reasons that I won‚Äôt go into in this post.</p>
<p>Now, the thing is that UTF-8 encoding doesn‚Äôt just convert the Unicode code point to its binary presentation. It does it in a specific way. The following table from wikipedia explains very well the conversion from code points to UTF8-encoding.</p>
<p>This table shows four ranges, the 1st range is encoded using 1 byte only, the second one 2 bytes, etc. Each range has its own norm for encoding code points using UTF-8.</p>
<p align="center">
<img src="https://chsafouane.github.io/posts/Byte Pair Encoding Tokenization/assets/utf8_table.png">
</p>
<p><strong>Character ÿµ example</strong>:</p>
<p>The character <code>ÿµ</code> code point is <code>U+0635</code> (1589 in decimal). If you try to represent this using binary presentation, it doesn‚Äôt fit into 1 byte, you‚Äôll need to use 2 bytes.</p>
<p>Using 2 bytes, it yields the following <code>00000110 00110101</code>. Now, UTF-8 doesn‚Äôt use conversion to bytes to encode code points. It has its own rules to do the encoding.</p>
<p>Now, if you look at the table, you see that <code>U+0635</code> falls between the range of <code>U+0080</code> and <code>U+07FF</code>. So, we have to use the rule in the second row to encode it using UTF-8.</p>
<p>The way to do this is to fill the <code>x</code> with the numbers in the binary representation starting from the right (copy-paste digit from the binary representation starting from the right): - Before filling: [110]xxxxx [10]xxxxxx - After filling: [110]11000 [10]110101. In hexadecimal, this yields <code>d8 b5</code>.</p>
<div id="cell-21" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The byte 11011000 yields in hexadecimal: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">hex</span>(<span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0b11011000</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb11-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The byte 10110101 yields in hexadecimal: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">hex</span>(<span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0b10110101</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The byte 11011000 yields in hexadecimal: 0xd8
The byte 10110101 yields in hexadecimal: 0xb5</code></pre>
</div>
</div>
<p>Now, this should match the result of the UTF-8 encoding of the character <code>ÿµ</code> using Python</p>
<div id="cell-23" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"ÿµ"</span>.encode(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utf-8"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>b'\xd8\xb5'</code></pre>
</div>
</div>
<p>The same rule can be applied to all the 4 ranges in order to go from a code point to its UTF-8 encoding.</p>
<p>At this step, I suggest you pick some characters from the unicode table page I‚Äôve given you above and do the encoding manually.</p>
<p><strong>Note</strong>: There is something that you should note at this step: - Unicode allows us to go from a character to a code point - The UTF-8 encoding (which is one of Unicode available encodings) allows us to go from a code point to a 1 to 4 bytes representation, depending on the character.</p>
<p>This yields the following trajectory: <code>Unicode character</code> &lt;-&gt; <code>Code point</code> -&gt; <code>1 to 4 bytes representation</code>.</p>
<p>Now, if you take any 1 to 4 bytes number, it doesn‚Äôt always map to a code point as it might not respect the rules specified in the wikipedia table above. For example, <code>11111111</code> (255 in decimal) corresponds to 1 byte but it‚Äôs not a valid unicode encoding. This is because the rule specifies that all 1-byte encoded characters should start with a <code>0</code> and not a <code>1</code>.</p>
</section>
<section id="a-sentence-example" class="level3">
<h3 class="anchored" data-anchor-id="a-sentence-example"><a id="toc1_2_3_"></a>A sentence example</h3>
<p>Let us now encode a whole sentence and see the result: <code>Hello there ÿµŸÅŸàÿßŸÜ</code></p>
<div id="cell-28" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">ex_sentence <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello there ÿµŸÅŸàÿßŸÜ"</span></span>
<span id="cb15-2"></span>
<span id="cb15-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The UTF-8 encoding of the sentence '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ex_sentence<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">' is: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ex_sentence<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>encode(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'UTF-8'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The UTF-8 encoding of the sentence 'Hello there ÿµŸÅŸàÿßŸÜ' is: b'Hello there \xd8\xb5\xd9\x81\xd9\x88\xd8\xa7\xd9\x86'</code></pre>
</div>
</div>
<p>I hope you at least recognize the UTF-8 encoding of the character <code>ÿµ</code>: <code>\xd8\xb5</code></p>
<p>A question that might come to your mind upong seeing the result is why the hell we have characters like <code>H</code> in a bytes representation. This is something that has to do with the display of bytes in Python.</p>
<p>Python uses a mixed representation of bytes for readability: - ASCII characters, even when encoded as bytes, are displayed in their readable form - Non-ASCII characters, when encoded as bytes, are displayed in hexadecimal format</p>
<p>It‚Äôs just a displaying matter !</p>
</section>
</section>
<section id="bpe-tokenization" class="level2">
<h2 class="anchored" data-anchor-id="bpe-tokenization"><a id="toc1_3_"></a>BPE Tokenization</h2>
<p>In order to feed data to a model, we have to first convert it to numerical data. The process for NLP models looks as follow:</p>
<p align="center">
Text ‚Äî&gt; Tokenizer ‚Äî&gt; Numerical ids (tokens) ‚Äî&gt; NLP model ‚Äî&gt; Prediction
</p>
<p>Now, if you look at the definition of <code>str</code> in Python, it‚Äôs defined as follows:</p>
<pre><code>Textual data in Python is handled with str objects, or strings. Strings are immutable sequences of Unicode code points</code></pre>
<p>From this definition, you can decide to just map every unicode character to its code point. For e.g, <code>ÿµ</code> will be mapped to <code>1589</code>. Using this technique will yield a vocabulary of almost 150 000 tokens.</p>
<p>The problem with this is: - Your vocabulary will be big. This means that your model will have embedding layers of 150 000 * size_of_your_embeddding - With that many characters, it‚Äôs very likely that your model training dataset won‚Äôt contain many of them that often, if not at all. If your model gets to see <code>ÿµ</code> very few times, its embedding will be very ill trained. At the end of training, its embedding will be very close to its random initialization state and would be of no use at all. - As your input sentence will be divided in unique characters, a simple sentence will consume lots of tokens in your input context. This means that: - At inference, you‚Äôll have to make predictions for every character - Your sentence will take so much memory because even a simple sentence will be long, many embeddings used and calculations will have to be made over all those embeddings - Simple text will consume so much of the model context size</p>
<p>Let look at this famous sentence <code>The quick brown fox jumps over the lazy dog</code>. If every character is considered a token, it will consist of 28 different tokens</p>
<div id="cell-32" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">example_sentence<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The quick brown fox jumps over the lazy dog"</span></span>
<span id="cb18-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Number of tokens in </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>example_sentence<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> is: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>([e <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> e <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> example_sentence]))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of tokens in The quick brown fox jumps over the lazy dog is: 28</code></pre>
</div>
</div>
<p>If we use GPT-4o tokenizer that is a BPE tokenizer itself, let us see how many tokenizer we get:</p>
<div id="cell-34" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tiktoken</span>
<span id="cb20-2"></span>
<span id="cb20-3">tokenizer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tiktoken.get_encoding(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"o200k_base"</span>)</span>
<span id="cb20-4">encoded_input <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenizer.encode(example_sentence)</span>
<span id="cb20-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Number of tokens in </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>example_sentence<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with GPT-4o tokenizer is: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(encoded_input)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of tokens in The quick brown fox jumps over the lazy dog with GPT-4o tokenizer is: 9</code></pre>
</div>
</div>
<p>When we look at the tokens resulting from GPT-4o tokenizer, we get to see that every word is a token in this case.</p>
<div id="cell-36" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> token <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> encoded_input:</span>
<span id="cb22-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The token with id </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>token<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> represents </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tokenizer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>decode_single_token_bytes(token)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The token with id 976 represents b'The'
The token with id 4853 represents b' quick'
The token with id 19705 represents b' brown'
The token with id 68347 represents b' fox'
The token with id 65613 represents b' jumps'
The token with id 1072 represents b' over'
The token with id 290 represents b' the'
The token with id 29082 represents b' lazy'
The token with id 6446 represents b' dog'</code></pre>
</div>
</div>
<p>If you‚Äôd like to play with different tokenizers, visit this page: https://tiktokenizer.vercel.app/, select the tokenizer and get going!</p>
<section id="bpe-in-action" class="level3">
<h3 class="anchored" data-anchor-id="bpe-in-action"><a id="toc1_3_1_"></a>BPE in action</h3>
<p>For this, you‚Äôll need to install <code>tiktoken</code> package using <code>pip install tiktoken</code>.</p>
<div id="cell-39" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tiktoken</span>
<span id="cb24-2"></span>
<span id="cb24-3">tokenizer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tiktoken.get_encoding(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"o200k_base"</span>)</span></code></pre></div>
</div>
<div id="cell-40" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">input_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"My name is ÿµŸÅŸàÿßŸÜ"</span></span>
<span id="cb25-2">encoded_input <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenizer.encode(input_str)</span>
<span id="cb25-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The result of tokenization consists of </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(encoded_input)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> tokens: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>encoded_input<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The result of tokenization consists of 5 tokens: [5444, 1308, 382, 37315, 10878]</code></pre>
</div>
</div>
<p>Let us decode each one of these tokens and see what they consist of:</p>
<div id="cell-42" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> token <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> encoded_input:</span>
<span id="cb27-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The token with id </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>token<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> represents </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tokenizer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>decode_single_token_bytes(token)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The token with id 5444 represents b'My'
The token with id 1308 represents b' name'
The token with id 382 represents b' is'
The token with id 37315 represents b' \xd8\xb5\xd9\x81'
The token with id 10878 represents b'\xd9\x88\xd8\xa7\xd9\x86'</code></pre>
</div>
</div>
<p>I hope you recognize, in the 4th print statement, the hexadecimal representation of the character <code>ÿµ</code> We can see that the fourth</p>
<div id="cell-44" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">[tokenizer.decode_single_token_bytes(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> encoded_input]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>[b'My', b' name', b' is', b' \xd8\xb5\xd9\x81', b'\xd9\x88\xd8\xa7\xd9\x86']</code></pre>
</div>
</div>
<p>Let us decode that fourth element and see what it consists of:</p>
<div id="cell-46" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1">tokenizer.decode_single_token_bytes(encoded_input[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]).decode(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utf-8"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>' ÿµŸÅ'</code></pre>
</div>
</div>
<p>We can see that this token consists of 3 unicode characters: - The space character - <code>ÿµ</code>, the character with the code point <code>U+0635</code>, whose UTF-8 encoding is <code>d8 b5</code> - <code>ŸÅ</code>, the character with the code point <code>U</code>, whose UTF-8 encoding is <code>d9 81</code></p>
</section>
<section id="how-does-it-work" class="level3">
<h3 class="anchored" data-anchor-id="how-does-it-work"><a id="toc1_3_2_"></a>How does it work</h3>
<p>As you might have guessed from its name, the Byte Pair Encoding mechanism does mainly two things to tokenize your data: - It represents strings as streams of bytes. Now, if you represent your data using only bytes, as a character usually consists of many bytes, that will be worse than using unicode code points as tokenized strings will be very very long. A byte can go only from 0 to 255.</p>
<ul>
<li>When some pair of bytes are so common in the corpus, it‚Äôs going to merge them going forward and assign a new id to them. So, in the example of the token ‚Äô ÿµŸÅ‚Äô, GPT-4 tokenizer has decided to merge the bytes that these two arabic characters consist of, meaning these four bytes:
<ul>
<li>space character (20 in hex, 32 in decimal)</li>
<li>d8 (216 in decimal)</li>
<li>b5 (181 in decimal)</li>
<li>d9 (217 in decimal)</li>
<li>81 (129 in decimal)</li>
</ul></li>
</ul>
<p>and assigned to the whole token <code>'  ÿµŸÅ'</code> the id <code>37315</code>.</p>
<p>Of course, the vocabulary identified by tokenizers can‚Äôt just grow indefinitly. otherwise, your model embedding table will also be huge and the model will be practically unusable. That‚Äôs why BPE tokenizers have a hyperparameter that specifies the number of merges that can be done when training.</p>
<p><strong>A quick recap:</strong> When training a tokenizer, convert string to bytes. The result will consist of numbers going from 0 to 255. Merge bytes that come-up together so often and assign an id to them.</p>
</section>
<section id="let-us-build-a-bpe-tokenizer" class="level3">
<h3 class="anchored" data-anchor-id="let-us-build-a-bpe-tokenizer"><a id="toc1_3_3_"></a>Let us build a BPE tokenizer</h3>
<section id="encoding" class="level4">
<h4 class="anchored" data-anchor-id="encoding"><a id="toc1_3_3_1_"></a>Encoding</h4>
<p>So, we basically need to do three things to build our tokenizer: - Define our basic vocab that we‚Äôll grow as we merge the most common pair of bytes - Convert our corpus to a stream of bytes (just encoding it using UTF-8) - Do the following <code>number_of_merges</code> times: - Get the most common pair of bytes - Merge the two pairs in a new id. Everytime the tokenizer will see the two pairs together, it will map them to the new ID.</p>
<p>So, our starting vocab is just the 1 byte interval (0 to 255), and as we merge the most common, we‚Äôll append new ids corresponding to the merged bytes.</p>
<div id="cell-52" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1">vocab <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {i:i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>)}</span></code></pre></div>
</div>
<p>As stated before, the first step is to convert our corpus to a stream of bytes by encoding using UTF-8.</p>
<p>Let us start with a very basic training corpus, it will make testing our functions very easy. Later, we‚Äôll use a corpus consisting of many languages.</p>
<div id="cell-55" class="cell" data-execution_count="131">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">corpus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Hello Hello Hello my name is Safouane and I am the author of this post"</span></span></code></pre></div>
</div>
<div id="cell-56" class="cell" data-execution_count="132">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1">encoded_corpus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> corpus.encode(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>)</span></code></pre></div>
</div>
<p>As we want to use bytes using the decimal representation (0-255) instead of hexadecimal (0x00 - 0xFF) (the default after encoding with UTF-8) for readability purposes, we‚Äôll do the conversion right away</p>
<div id="cell-58" class="cell" data-execution_count="133">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">encoded_corpus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> encoded_corpus]</span>
<span id="cb36-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(encoded_corpus[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[72, 101, 108, 108, 111, 32, 72, 101, 108, 108]</code></pre>
</div>
</div>
<p>Let build a function that returns the most common pair of bytes in the whole corpus</p>
<div id="cell-60" class="cell" data-execution_count="134">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Counter</span>
<span id="cb38-2"></span>
<span id="cb38-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_most_common_pair(encoded_corpus: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>:</span>
<span id="cb38-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Returns a tuple of the most common pair of bytes in a corpus.</span></span>
<span id="cb38-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb38-6">    most_common_pair_and_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(encoded_corpus[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], encoded_corpus[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:])).most_common(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb38-7">    most_common_pair <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> most_common_pair_and_count[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb38-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> most_common_pair</span></code></pre></div>
</div>
<p>Let us see what‚Äôs the most common pair of bytes in this corpus</p>
<div id="cell-62" class="cell" data-execution_count="135">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">most_common_pair <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_most_common_pair(encoded_corpus)</span>
<span id="cb39-2"></span>
<span id="cb39-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The most common pair is </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>most_common_pair<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>most_common_pair[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> corresponds to </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">chr</span>(most_common_pair[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> and </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>most_common_pair[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> corresponds to </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">chr</span>(most_common_pair[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The most common pair is (72, 101). 72 corresponds to H and 101 corresponds to e</code></pre>
</div>
</div>
<p>Let us write a function that takes the encoded corpus, the vocabulary, the pair of ids to merge and: - Updates the vocabulary by adding the new id that replaces the occurence of the pair of the ids to merge - Updates the corpus by replacing the occurence of the pair of ids with the new id</p>
<div id="cell-64" class="cell" data-execution_count="136">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> merge_and_update_corpus_and_vocab(encoded_corpus, vocab, pair_to_merge):</span>
<span id="cb41-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Updates the vocab with the new pair of ids to merge</span></span>
<span id="cb41-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    &amp; updates the corpus to use the new id instead of the pair of bytes</span></span>
<span id="cb41-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb41-5">    updated_corpus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb41-6">    updated_vocab <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vocab.copy()</span>
<span id="cb41-7"></span>
<span id="cb41-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add id for merged pair in vocab</span></span>
<span id="cb41-9">    pair_new_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(vocab.keys()) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb41-10">    updated_vocab[pair_new_id] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pair_to_merge</span>
<span id="cb41-11"></span>
<span id="cb41-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update corpus to use the new id instead of the couple the pair of ids</span></span>
<span id="cb41-13">    i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb41-14"></span>
<span id="cb41-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(encoded_corpus):</span>
<span id="cb41-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(encoded_corpus) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> encoded_corpus[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pair_to_merge[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> encoded_corpus[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> pair_to_merge[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]:</span>
<span id="cb41-17">            updated_corpus.append(pair_new_id)</span>
<span id="cb41-18">            i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb41-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb41-20">            updated_corpus.append(encoded_corpus[i])</span>
<span id="cb41-21">            i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb41-22">    </span>
<span id="cb41-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> updated_corpus, updated_vocab</span></code></pre></div>
</div>
<p>Let us merge now the most common pair of bytes and create one id out of it. The successive 101,32 will be turned into 256.</p>
<div id="cell-66" class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1">updated_corpus_ex, updated_vocab_example <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> merge_and_update_corpus_and_vocab(</span>
<span id="cb42-2">    encoded_corpus, </span>
<span id="cb42-3">    vocab,</span>
<span id="cb42-4">    get_most_common_pair(encoded_corpus)    </span>
<span id="cb42-5">)</span></code></pre></div>
</div>
<p>We can see the presence of a new token id in the corpus: <code>256</code></p>
<div id="cell-68" class="cell" data-execution_count="139">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(updated_corpus_ex[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[256, 108, 108, 111, 32, 256, 108, 108, 111, 32]</code></pre>
</div>
</div>
<p>When we check the vocab to see to what it corresponds, we see that it‚Äôs a merge of two ids: <code>72</code> and <code>101</code>.</p>
<div id="cell-70" class="cell" data-execution_count="140">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(updated_vocab_example[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(72, 101)</code></pre>
</div>
</div>
<p>We‚Äôve seen how merging works. Now, we have to apply this merging a <code>number_of_merges</code> times. What you should keep in mind is the following: - You vocab will grow with the number of merges you apply. Say you apply 10 merges, your vocab will go from 256 ids to 266 ids. - The bigger your vocab gets, the bigger your embedding table (whose size corresponds to number of tokens in the vocab * size of embedding) will grow. - Merging indefinitly is not a good idea. The different ids in your vocab will not come up often as tokens in the training corpus of your model. Consequently, some tokens will have random embeddings - Having merged tokens allows you to make good use of your context size as your tokens will can even represent complete words at times</p>
<div id="cell-72" class="cell" data-execution_count="141">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> merge_iteratively(corpus, vocab, number_of_merges: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>):</span>
<span id="cb47-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(number_of_merges):</span>
<span id="cb47-3">        most_common_pair <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_most_common_pair(corpus)</span>
<span id="cb47-4">        corpus, vocab <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> merge_and_update_corpus_and_vocab(corpus, vocab, most_common_pair)</span>
<span id="cb47-5">    </span>
<span id="cb47-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> corpus, vocab</span></code></pre></div>
</div>
<div id="cell-73" class="cell" data-execution_count="142">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1">three_merges_corpus, three_merges_vocab <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> merge_iteratively(encoded_corpus, vocab, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb48-2"></span>
<span id="cb48-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"A glimpse at the start of new corpus: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>three_merges_corpus[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb48-4"></span>
<span id="cb48-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The merged ids: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>[three_merges_vocab[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> x] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A glimpse at the start of new corpus: [258, 111, 32, 258, 111, 32, 258, 111, 32, 109]
The merged ids: [(72, 101), (256, 108), (257, 108)]</code></pre>
</div>
</div>
<p>Now, the <code>merge_iteratively</code> function if it‚Äôs out of pairs that occur more than once, it will start merging pairs that occur only once. This is not a desired behavior.</p>
<p>This can be handled easily by returning the count of the number of occurences as well in <code>get_most_common_pair</code> and checking that it‚Äôs greater than 1 to proceed to merging.</p>
<div id="cell-75" class="cell" data-execution_count="143">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_most_common_pair(encoded_corpus: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>:</span>
<span id="cb50-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Returns a tuple:</span></span>
<span id="cb50-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - A tuple of the most common pair of ids in a corpus</span></span>
<span id="cb50-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - The number of occurences of the pair of ids</span></span>
<span id="cb50-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb50-6">    most_common_pair_and_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Counter(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(encoded_corpus[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], encoded_corpus[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:])).most_common(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb50-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> most_common_pair_and_count</span></code></pre></div>
</div>
<div id="cell-76" class="cell" data-execution_count="144">
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> merge_iteratively(corpus, vocab, number_of_merges: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>):</span>
<span id="cb51-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(number_of_merges):</span>
<span id="cb51-3">        most_common_pair, count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_most_common_pair(corpus)</span>
<span id="cb51-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb51-5">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb51-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb51-7">            corpus, vocab <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> merge_and_update_corpus_and_vocab(corpus, vocab, most_common_pair)</span>
<span id="cb51-8">    </span>
<span id="cb51-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> corpus, vocab</span></code></pre></div>
</div>
<p>Let put all these functions in one function that should do the encoding of a string</p>
<div id="cell-78" class="cell" data-execution_count="219">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> encode(corpus: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, num_merges: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>):</span>
<span id="cb52-2">    encoded_corpus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> corpus.encode(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>)</span>
<span id="cb52-3">    base_vocab <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {i:i <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>)}</span>
<span id="cb52-4">    updated_corpus, updated_vocab <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> merge_iteratively(encoded_corpus, base_vocab, num_merges)</span>
<span id="cb52-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> updated_corpus, updated_vocab</span></code></pre></div>
</div>
<p>Now that we can train a tokenizer and encode a string, all that‚Äôs left is decoding.</p>
</section>
<section id="decoding" class="level4">
<h4 class="anchored" data-anchor-id="decoding"><a id="toc1_3_3_2_"></a>Decoding</h4>
<p>Now, to detokenize tokenized text, it‚Äôs not that hard - First, you have to reverse the mapping. You have to unpair the ids. If for example, the id 257=(100,256) and 256=(255, 20), we have to unpair those. But in order for the unpairing to work, we have to unpair the ids starting from the highest id, 257 in this case. 257 will be replaced with (100 and 256) and then 256 can be replaced with (255 and 20). If you don‚Äôt do it in the right order, you‚Äôll have some composed ids left and you won‚Äôt be able to decode them. - Once the mapping is reversed, you can decode the stream of bytes using UTF-8</p>
<div id="cell-82" class="cell">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1">three_merges_corpus, three_merges_vocab <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> encode(corpus, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
</div>
<p>Let us first build a function that will help us get the pair of ids that were replaced with a new id</p>
<div id="cell-84" class="cell" data-execution_count="187">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> unpair_ids(corpus, vocab):</span>
<span id="cb54-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Reverses new ids in the vocab to their</span></span>
<span id="cb54-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    orignal pair of ids.</span></span>
<span id="cb54-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb54-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> token <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(vocab.keys(), reverse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>):</span>
<span id="cb54-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>:</span>
<span id="cb54-7">            unpaired_corpus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb54-8">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(corpus)):</span>
<span id="cb54-9">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> corpus[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> token:</span>
<span id="cb54-10">                    unpaired_corpus.append(vocab[token][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb54-11">                    unpaired_corpus.append(vocab[token][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb54-12">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb54-13">                    unpaired_corpus.append(corpus[i])</span>
<span id="cb54-14">                </span>
<span id="cb54-15">            corpus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(unpaired_corpus)</span>
<span id="cb54-16">    </span>
<span id="cb54-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> unpaired_corpus</span></code></pre></div>
</div>
<div id="cell-85" class="cell" data-execution_count="191">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The first ten tokens of the tokenized corpus looks like: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>three_merges_corpus[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb55-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The first ten tokens of the unpaired corpus looks as follows: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>unpair_ids(three_merges_corpus[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>], three_merges_vocab)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The first ten tokens of the tokenized corpus looks like: [258, 111, 32, 258, 111, 32, 258, 111, 32, 109]
The first ten tokens of the unpaired corpus looks like: [72, 101, 108, 108, 111, 32, 72, 101, 108, 108, 111, 32, 72, 101, 108, 108, 111, 32, 109]</code></pre>
</div>
</div>
<p>Now that we recovered the corpus with the bytes ids, we can do the UTF-8 decoding:</p>
<div id="cell-87" class="cell" data-execution_count="201">
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> decode(tokenized_corpus_with_merges, vocab_with_merges):</span>
<span id="cb57-2">    unpaired_tokenized_corpus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> unpair_ids(tokenized_corpus_with_merges, vocab_with_merges)</span>
<span id="cb57-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The UTF-8 decoding expects byte objects and not int, we have to convert them to byte first</span></span>
<span id="cb57-4">    decoded_corpus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">b""</span>.join([x.to_bytes() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> unpaired_tokenized_corpus]).decode(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>)</span>
<span id="cb57-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> decoded_corpus</span></code></pre></div>
</div>
<div id="cell-88" class="cell" data-execution_count="206">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1">decoded_corpus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> decode(three_merges_corpus, three_merges_vocab)</span>
<span id="cb58-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The decoding of the corpus yields: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>decoded_corpus<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb58-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Check of equality with the original corpus: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>decoded_corpus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> corpus<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The decoding of the corpus yields: Hello Hello Hello my name is Safouane and I am the author of this post
Check of equality with the original corpus: True</code></pre>
</div>
</div>
</section>
<section id="one-last-problem-to-solve" class="level4">
<h4 class="anchored" data-anchor-id="one-last-problem-to-solve"><a id="toc1_3_3_3_"></a>One last problem to solve</h4>
<p>When encoding, we get to add new ids as tokens and we just incremented with 1 each time. Now, remember this table from wikipedia:</p>
<p align="center">
<img src="https://chsafouane.github.io/posts/Byte Pair Encoding Tokenization/assets/utf8_table.png">
</p>
<p>What this table entails is that not all bytes are valid UTF-8 encodings. For example, any 1-byte number starting with 1 its binary representation is not a valid UTF-8 encoding. The number <code>10000000</code> (which corresponds to 128 in the decimal representation) is not a valid UTF-8 encoding.</p>
<p>Let us check what Python will say if we try to decode it using UTF-8</p>
<div id="cell-92" class="cell" data-execution_count="215">
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the int to a bytes object</span></span>
<span id="cb60-2">example_byte <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0b10000000</span>.to_bytes()</span>
<span id="cb60-3"></span>
<span id="cb60-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Decode it using UTF-8</span></span>
<span id="cb60-5">example_byte.decode(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>)</span></code></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">UnicodeDecodeError</span>                        Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[215], line 5</span>
<span class="ansi-green-fg ansi-bold">      2</span> example_byte <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(98,98,98)">0b10000000</span><span style="color:rgb(98,98,98)">.</span>to_bytes()
<span class="ansi-green-fg ansi-bold">      4</span> <span style="font-style:italic;color:rgb(95,135,135)"># Decode it using UTF-8</span>
<span class="ansi-green-fg">----&gt; 5</span> example_byte<span style="color:rgb(98,98,98)">.</span>decode(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">UTF-8</span><span style="color:rgb(175,0,0)">"</span>)

<span class="ansi-red-fg">UnicodeDecodeError</span>: 'utf-8' codec can't decode byte 0x80 in position 0: invalid start byte</pre>
</div>
</div>
</div>
<p>The error says <code>invalid start byte</code>, can‚Äôt be any clearer !</p>
<p>Now, what should we do if we encounter such integers in our encoded corpus ? The way this is circumvented in GPT-4 tokenizer for example is by decoding that integer into a specific character <code>ÔøΩ</code>. This is the default value that any invalid integer is decoded into with <code>decode</code> method using UTF-8 encoding in Python.</p>
<div id="cell-95" class="cell" data-execution_count="217">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1">example_byte.decode(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>, errors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"replace"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="217">
<pre><code>'ÔøΩ'</code></pre>
</div>
</div>
</section>
<section id="one-final-example" class="level4">
<h4 class="anchored" data-anchor-id="one-final-example"><a id="toc1_3_3_4_"></a>One final example</h4>
<p>As an example of our training corpus, we‚Äôll take the description in english, french and arabic of <code>1337</code>, one of the leading IT schools in the world that is located in Morocco. This description will constitute our corpus that we‚Äôll use to train our tokenizer.</p>
<div id="cell-98" class="cell" data-execution_count="236">
<div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1">input_string <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""1337 is the first to provide IT training in Morocco, completely free of charge, open and accessible to anyone between the ages of 18 and 30. No need for an IT degree, or of having undergone extensive IT training. The only criteria for admission in Treize, Trente-Sept is CREATIVITY.</span></span>
<span id="cb63-2"></span>
<span id="cb63-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">The Treize, Trente-Sept educational approach is based on peer-learning. A participatory operating style allowing students to unleash their creativity through project-based learning. To train the future coders of tomorrow, we had to rethink learning. We had to make IT something fun, exciting and at odds with the restrictive vision that the general public may have about it.</span></span>
<span id="cb63-4"></span>
<span id="cb63-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">1337 is the coding school par excellence, completely free of charge and accessible to all with no prerequisite of a degree. It offers a full immersion in a universe where the future is already present. Where IT and the lines of code are way more than a vague and off-putting concept‚Ä¶</span></span>
<span id="cb63-6"></span>
<span id="cb63-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Treize, Trente-Sept, a forward-looking school from the present.</span></span>
<span id="cb63-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">1337, c‚Äôest la premi√®re formation en informatique par excellence au Maroc, enti√®rement gratuite, ouverte 24h/24 7j/7 et accessible √† tous sans pr√©-requis de dipl√¥me, ou de connaissance en informatique.. C‚Äôest une immersion compl√®te dans un univers o√π le futur est d√©j√† pr√©sent, o√π l‚Äôinformatique et les lignes de codes sont plus qu‚Äôun concept flou et r√©barbatif‚Ä¶</span></span>
<span id="cb63-9"></span>
<span id="cb63-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">La p√©dagogie de Treize, Trente-Sept s‚Äôarticule autour du peer-learning. Un fonctionnement participatif qui permet aux √©tudiants de lib√©rer leur cr√©ativit√© gr√¢ce √† l‚Äôapprentissage par projet. Pour former les futurs codeurs de demain, il fallait repenser l‚Äôapprentissage, faire de l‚Äôinformatique quelque chose de ludique, de passionnant et aux antipodes de la vision restrictive que le grand public peut en avoir.</span></span>
<span id="cb63-11"></span>
<span id="cb63-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Treize, Trente-Sept utilise les m√©thodes techniques et p√©dagogiques de 42 Paris, √©lue meilleure √©cole de code au monde par CodinGame.</span></span>
<span id="cb63-13"></span>
<span id="cb63-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Treize, Trente-Sept, une √©cole du pr√©sent tourn√©e vers le futur.</span></span>
<span id="cb63-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">1337 ŸáŸä ÿ£ŸàŸÑ ÿ™ŸÉŸàŸäŸÜ ŸÖÿπŸÑŸàŸÖÿßÿ™Ÿä ŸÅÿßŸÑŸÖÿ∫ÿ±ÿ®ÿå ŸÉŸÑŸà ÿ®ÿßŸÑŸÖÿ¨ÿßŸÜÿå ŸÖŸÅÿ™Ÿàÿ≠ ŸÑŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÑŸä ÿ™Ÿäÿ™ÿ±ÿßŸàÿ≠ ÿπŸÖÿ±ŸáŸÖ ÿ®ŸäŸÜ 18 Ÿà30 ÿ≥ŸÜÿ©. ŸÖÿß ŸÖÿ≠ÿ™ÿßÿ¨ÿ¥ ŸäŸÉŸàŸÜ ÿπŸÜÿØŸÉ ÿØÿ®ŸÑŸàŸÖ ŸÅÿßŸÑŸÖÿπŸÑŸàŸÖŸäÿßÿ™ÿå ÿ£Ÿà ÿ™ŸÉŸàŸÜ ÿØÿ±ÿ™Ÿä ÿ¥Ÿä ÿ™ŸÉŸàŸäŸÜ ÿ£Ÿà ÿ™ÿÆÿµÿµ ŸÅÿßŸÑŸÖÿπŸÑŸàŸÖŸäÿßÿ™. ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑŸàÿ≠ŸäÿØ ÿßŸÑŸÑŸä ŸÉŸäÿ™Ÿäÿ≠ ŸÑŸÉ ÿ®ÿßÿ® ÿßŸÑÿØÿÆŸàŸÑ ŸÑ 1337 ŸáŸà ÿßŸÑÿ•ÿ®ÿØÿßÿπ.</span></span>
<span id="cb63-16"></span>
<span id="cb63-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">ÿßŸÑÿ®ŸäÿØÿßÿ∫Ÿàÿ¨Ÿäÿ© ÿØŸäÿßŸÑ 1337 ŸÉÿ™ÿπÿ™ŸÖÿØ ÿπŸÑŸâ peer-learning ÿßŸÑŸÑŸä ŸáŸà ŸÜŸàÿπ ŸÖŸÜ ÿßŸÑÿ™ÿπŸÑŸÖ ÿßŸÑÿ™ÿπÿßŸàŸÜŸä ÿßŸÑŸÑŸä ŸÉŸäÿ≥ÿßÿπÿØ ÿßŸÑÿ∑ŸÑÿ®ÿ© ÿπŸÑŸâ ÿ™ÿ≠ÿ±Ÿäÿ± ÿßŸÑÿ•ÿ®ÿØÿßÿπ ÿØŸäÿßŸÑŸáŸÖ ÿ®ŸÅÿ∂ŸÑ ÿßŸÑÿ™ÿπŸÑŸÖ ÿ®ÿ•ŸÜÿ¨ÿßÿ≤ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ. Ÿàÿ®ÿßÿ¥ ŸÜŸÉŸàŸëŸÜŸà ŸÖÿ®ÿ±ŸÖÿ¨Ÿä ÿßŸÑÿ∫ÿØÿå ÿßŸÑŸÑŸä ŸÉŸäŸÉŸàÿØŸäŸàÿå ŸÉÿßŸÜ ŸÑÿßÿ≤ŸÖ ŸÜÿ±ÿßÿ¨ÿπŸà ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ™ÿπŸÑŸÖÿå ŸàŸÜÿ¨ÿπŸÑŸà ÿ™ÿπŸÑŸÖ ÿßŸÑŸÖÿπŸÑŸàŸÖŸäÿßÿ™ ÿπŸÖŸÑŸäÿ© ÿ™ÿ±ŸÅŸäŸáŸäÿ©ÿå ŸÅŸäŸáÿß ÿßŸÑÿ±ÿ∫ÿ®ÿ© ŸàÿßŸÑÿ¥ÿ∫ŸÅÿå ŸÖÿßÿ¥Ÿä ŸÉŸäŸÅ ŸÉŸäÿ™ÿÆŸäŸÑŸàŸáÿß ÿßŸÑŸÜÿßÿ≥.</span></span>
<span id="cb63-18"></span>
<span id="cb63-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">1337 ŸáŸä ŸÖÿØÿ±ÿ≥ÿ© ÿßŸÑŸÉŸàÿØ ÿ®ÿßŸÖÿ™Ÿäÿßÿ≤ÿå ŸÖÿ¨ÿßŸÜŸäÿ© ŸàŸÅŸÖÿ™ŸÜÿßŸàŸÑ ÿßŸÑÿ¨ŸÖŸäÿπ, ŸàŸÖÿß ÿ™ÿ™ÿ∑ŸÑÿ®ÿ¥ ŸÖŸÜŸÉ ÿ™ŸÉŸàŸÜ ÿ≠ÿßÿ¶ÿ≤ ÿπŸÑŸâ ÿØÿ®ŸÑŸàŸÖ. Ÿàÿ™ÿπÿ™ÿ®ÿ± ÿßŸÜÿØŸÖÿßÿ¨ ŸÉÿßŸÖŸÑÿå ŸÅÿπÿßŸÑŸÖ ŸÖÿ≥ÿ™ŸÇÿ®ŸÑŸä ÿßŸÑŸÑŸä ŸÖÿß ÿ®ŸÇÿßÿ¥ ŸÅŸäŸá ÿßŸÑŸÉŸàÿØ ŸÖŸÅŸáŸàŸÖ ÿ∫ÿßŸÖÿ∂.</span></span>
<span id="cb63-20"></span>
<span id="cb63-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">1337 ŸÖÿØÿ±ÿ≥ÿ© ÿßŸÑÿ≠ÿßÿ∂ÿ± ÿßŸÑŸÖÿ™ÿ∑ŸÑÿπÿ© ŸÑŸÑŸÖÿ≥ÿ™ŸÇÿ®ŸÑ.</span></span>
<span id="cb63-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span></code></pre></div>
</div>
<div id="cell-99" class="cell" data-execution_count="237">
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1">encoded_merged_input, updated_vocab <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> encode(input_string, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
</div>
<p>The added ids to the corpus are the following:</p>
<div id="cell-101" class="cell" data-execution_count="238">
<div class="sourceCode cell-code" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>({x:updated_vocab.get(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(updated_vocab.keys()) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)})</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{256: (101, 32), 257: (217, 132), 258: (216, 167), 259: (217, 133), 260: (217, 138), 261: (217, 136), 262: (32, 216), 263: (258, 257), 264: (114, 101), 265: (115, 32), 266: (105, 110), 267: (116, 32), 268: (32, 263), 269: (216, 170), 270: (44, 32), 271: (217, 134), 272: (216, 185), 273: (116, 105), 274: (217, 131), 275: (101, 114)}</code></pre>
</div>
</div>
<div id="cell-102" class="cell" data-execution_count="239">
<div class="sourceCode cell-code" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1">decoded_corpus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> decode(encoded_merged_input, updated_vocab)</span></code></pre></div>
</div>
<p>Let us check the decoded corpus against the original corpus:</p>
<div id="cell-104" class="cell" data-execution_count="240">
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1">decoded_corpus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> corpus</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="240">
<pre><code>True</code></pre>
</div>
</div>
<p>While in this case the result of the decoding process yields the same result as the original, you shouldn‚Äôt always expect it to be the case. If during the decoding process, we encounter an id (like 128) that we can‚Äôt decode using UTF-8, it will get replaced with <code>ÔøΩ</code> in the current implementation. The comparison of the decoding result with the original text won‚Äôt yield equality.</p>


</section>
</section>
</section>

 ]]></description>
  <category>Python</category>
  <category>NLP</category>
  <guid>https://chsafouane.github.io/posts/Byte Pair Encoding Tokenization/Byte Pair Encoding Tokenization.html</guid>
  <pubDate>Sat, 06 Jul 2024 22:00:00 GMT</pubDate>
</item>
</channel>
</rss>
